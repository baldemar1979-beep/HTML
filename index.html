<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fleet & Vehicle Event Dashboard</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; background:#f5f7fa; padding:18px; }
    .container { max-width:1950px; margin:0 auto; }

    .header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
    h1 { color:#2c3e50; font-size:22px; }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tabbtn{
      border:1px solid #dcdcdc; background:#fff; border-radius:12px; padding:8px 12px;
      font-weight:950; cursor:pointer; color:#2c3e50;
    }
    .tabbtn.active { border-color:#2c3e50; box-shadow:0 1px 2px rgba(0,0,0,0.08); }

    .date-display { font-size:14px; font-weight:950; color:#2c3e50; background:#fff; padding:8px 12px; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
    .info{
      background:#e8f4f8; border-left:4px solid #3498db; padding:10px 12px; margin: 8px 0 14px;
      font-size:13px; color:#34495e; line-height:1.35; border-radius:10px;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .info a { color:#1f5fa9; font-weight:900; text-decoration:none; }
    .info a:hover { text-decoration:underline; }
    .error { display:none; background:#fff3f3; border-left:4px solid #e74c3c; padding:12px; border-radius:10px; color:#7b241c; margin-bottom: 12px; }
    .error code { background:#fbeaea; padding:2px 6px; border-radius:4px; }

    /* ========= TOP CONTROLS ========= */
    .controls{
      background:#fff; padding:14px 18px; border-radius:14px; box-shadow:0 2px 4px rgba(0,0,0,0.08);
      margin-bottom:14px; display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
    }
    .controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      width: 100%;
    }
    .controls-title {
      font-weight: 950;
      color: #2c3e50;
      font-size: 16px;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
    }
    .block { min-width: 260px; flex: 1 1 320px; }
    .block.small { flex: 0 1 260px; min-width: 240px; }
    .block.wide { flex: 2 1 520px; min-width: 420px; }
    .fg { display:flex; flex-direction:column; }
    .fg label { font-weight:950; margin-bottom:6px; color:#2c3e50; font-size:13px; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; }
    .fg select, .fg input { padding:8px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px; background:#fff; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; }
    .hint { font-size:12px; color:#7f8c8d; margin-top:6px; line-height:1.3; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn { cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:12px; padding:8px 12px; font-weight:950; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; }
    .btn:hover { background:#f7f7f7; }

    .panel{ border:1px solid #eee; border-radius:14px; padding:8px; height: 170px; overflow:auto; background:#fafafa; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px 6px; border-bottom:1px solid #eee; font-size:13px; color:#2c3e50; }
    .item:last-child { border-bottom:none; }
    .left { display:flex; align-items:center; gap:10px; }
    .count { color:#7f8c8d; font-size:12px; }
    details { background:#fff; border:1px solid #eee; border-radius:14px; padding:10px; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; }
    summary { cursor:pointer; font-weight:950; color:#2c3e50; user-select:none; font-size:13px; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; }
    summary:hover { color:#1a252f; }
    .block details { background:#fff; border:1px solid #e0e0e0; margin:0; }
    .block summary { padding:8px 0; }

    /* ===== Custom Upload ===== */
    #csv-upload { display:none; }
    .uploader{
      border:1px solid #ddd; border-radius:14px; padding:10px; background:#fafafa; height: 170px;
      display:flex; flex-direction:column; justify-content:flex-start; gap:8px;
    }
    .upload-top { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .upload-btn{
      cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:12px; padding:8px 12px;
      font-weight:950; display:inline-flex; align-items:center; gap:8px; user-select:none;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
    }
    .upload-btn:hover { background:#f7f7f7; }
    .file-status{ font-size:12px; color:#7f8c8d; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .upload-actions { display:flex; gap:10px; flex-wrap:wrap; }

    /* ===== Stats row (Fleet tab only) ===== */
    .stats{
      background:#fff; padding:12px 14px; border-radius:14px; box-shadow:0 2px 4px rgba(0,0,0,0.08);
      margin-bottom:14px; display:flex; justify-content:space-around; flex-wrap:wrap; gap:10px;
    }
    .stat { text-align:center; min-width: 150px; }
    .stat .label { font-size:11px; color:#7f8c8d; text-transform:uppercase; letter-spacing:0.5px; }
    .stat .value { font-size:24px; font-weight:1000; color:#2c3e50; margin-top:5px; }

    .section-title { margin: 12px 2px 10px; color:#2c3e50; font-weight:1000; font-size:16px; }
    .card{ background:#fff; padding:12px 14px; border-radius:14px; box-shadow:0 2px 4px rgba(0,0,0,0.08); border:1px solid #f0f0f0; margin-bottom:14px; }

    .table-wrap { background:#fff; border-radius:14px; box-shadow:0 2px 4px rgba(0,0,0,0.08); overflow-x:auto; }
    table { width:100%; border-collapse:collapse; }
    thead { background:#34495e; color:#fff; position:sticky; top:0; z-index:10; }
    th { padding:12px; text-align:left; font-weight:950; font-size:12px; text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; cursor:pointer; user-select:none; }
    th:hover { background:#2c3e50; }
    th.sortable::after { content:' ‚áÖ'; opacity:0.5; }
    th.sort-asc::after { content:' ‚Üë'; opacity:1; }
    th.sort-desc::after { content:' ‚Üì'; opacity:1; }

    tbody tr { border-bottom:1px solid #ecf0f1; transition: background-color 0.2s; }
    tbody tr:hover { background:#f8f9fa; }
    td { padding:12px; font-size:14px; color:#2c3e50; }

    .fleet-row { background:#ecf0f1; font-weight:950; cursor:pointer; user-select:none; }
    .fleet-row:hover { background:#d5dbdb; }
    .fleet-row td:first-child { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .expand { width:12px; display:inline-block; transition:transform 0.2s; font-size:12px; }
    .expand.on { transform:rotate(90deg); }

    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; font-weight:1000; }
    .badge-info { background:#d1ecf1; color:#0c5460; }

    .ver-badge { background:#eef2f5; color:#2c3e50; }
    .ver-up { background:#e6f7e6; color:#1e5631; }
    .ver-old { background:#fff4cc; color:#7a5a00; }
    .ver-na { background:#f1f1f1; color:#7f8c8d; }

    .asset-row { display:none; }
    .asset-row.visible { display:table-row; }
    .asset-row td:first-child { padding-left:40px; color:#7f8c8d; }

    .num { text-align:right; font-variant-numeric: tabular-nums; }
    .no-data { text-align:center; padding:40px; color:#95a5a6; font-size:16px; display:none; }

    .prec-cell { padding:6px 10px; display:inline-block; min-width:76px; text-align:right; border-radius:10px; font-weight:1000; }
    .prec-bad { background:#ffe5e5; color:#7b241c; }
    .prec-warn { background:#fff4cc; color:#7a5a00; }
    .prec-good { background:#e6f7e6; color:#1e5631; }

    .tabpage { display:none; }
    .tabpage.active { display:block; }

    /* chips */
    .chip { display:inline-block; padding:6px 10px; border-radius:10px; font-weight:1000; font-size:13px; }
    .chip-red { background:#ffe5e5; color:#7b241c; }
    .chip-yellow { background:#fff4cc; color:#7a5a00; }
    .chip-green { background:#e6f7e6; color:#1e5631; }
    .chip-na { background:#eef2f5; color:#2c3e50; }

    .cell-green { background:#e6f7e6; border-radius:10px; padding:6px 10px; display:inline-block; }
    .subnote { font-size:12px; color:#7f8c8d; margin-top:6px; line-height:1.35; }

    /* KPI grid */
    .kpi-grid { display:flex; flex-wrap:wrap; gap:10px; }
    .kpi { flex: 1 1 180px; background:#fafafa; border:1px solid #eee; border-radius:14px; padding:10px 12px; min-width: 220px; }
    .kpi .k { font-size:11px; color:#7f8c8d; text-transform:uppercase; letter-spacing:0.5px; margin-top:6px; }
    .kpi .v { font-size:18px; font-weight:1000; color:#2c3e50; }

    /* Interventions KPI summary section */
    .int-header{
      background:#fff; border-radius:14px; box-shadow:0 2px 4px rgba(0,0,0,0.08);
      padding:14px 18px; margin-bottom:14px;
    }
    .int-kpi-title{ font-size:13px; font-weight:1000; color:#2c3e50; margin-bottom:8px; }
    .int-footnote{ font-size:12px; color:#7f8c8d; margin-top:10px; }

    /* Clickable count */
    .link { color:#1f5fa9; font-weight:1000; text-decoration:underline; text-underline-offset: 3px; cursor:pointer; }

    /* Email chips */
    .email-chip { display:inline-block; padding:6px 10px; border-radius:10px; font-weight:1000; font-size:13px; }
    .email-low { background:#eef2f5; color:#2c3e50; }   /* grey */
    .email-med { background:#fff4cc; color:#7a5a00; }   /* yellow */
    .email-high { background:#ffe5e5; color:#7b241c; }  /* red */
    .email-na { background:#f1f1f1; color:#7f8c8d; }    /* NA */

    /* ===== Evidence modal ===== */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; padding:20px; z-index:9999; }
    .modal{ width:min(1200px, 98vw); max-height: 88vh; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.25); overflow:hidden; display:flex; flex-direction:column; border:1px solid #eee; }
    .modal-header{ padding:12px 14px; background:#f8fafc; border-bottom:1px solid #eee; display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .modal-title{ font-size:14px; font-weight:1000; color:#2c3e50; line-height:1.25; }
    .modal-sub{ margin-top:6px; font-size:12px; color:#7f8c8d; line-height:1.35; }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .modal-body{ padding:12px 14px; overflow:auto; background:#fff; }
    .modal-close{ cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:12px; padding:8px 12px; font-weight:950; }
    .modal-close:hover{ background:#f7f7f7; }
    .modal-btn{ cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:12px; padding:8px 12px; font-weight:950; }
    .modal-btn:hover{ background:#f7f7f7; }
    .mini{ font-size:12px; color:#7f8c8d; }
    .small-table-wrap{ border:1px solid #eee; border-radius:14px; overflow:hidden; }
    .small-table-wrap table thead{ position:sticky; top:0; }
    .small-table-wrap th{ cursor:default; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Fleet & Vehicle Event Dashboard</h1>
      <div class="tabs">
        <button class="tabbtn active" data-tab="fleetTab">Fleet Management</button>
        <button class="tabbtn" data-tab="interventionsTab">Interventions</button>
        <button class="tabbtn" data-tab="fovTab">FOV</button>
        <button class="tabbtn" data-tab="trendsTab">Trends</button>
        <button class="tabbtn" data-tab="howTab">How To</button>
        <div class="date-display" id="date-display">Upload CSV(s)</div>
      </div>
    </div>

    <div id="error" class="error"></div>

    <!-- Upload and Controls Section -->
    <div class="controls">
      <div class="controls-header">
        <div class="controls-title">Controls <button class="btn" id="reset-filters" type="button">Reset Filters</button></div>
      </div>
      
      <!-- Upload -->
      <div class="block small">
        <details open>
          <summary>Upload Weekly CSV(s)</summary>
          <div class="fg" style="margin-top:10px;">
            <div class="upload-top">
              <label class="upload-btn" for="csv-upload">Choose Files</label>
              <button class="btn" id="clear-data" type="button">Clear Data</button>
              <input type="file" id="csv-upload" accept=".csv" multiple />
            </div>
          </div>
        </details>
      </div>

      <!-- Report Week -->
      <div class="block small">
        <details open>
          <summary>Report Week</summary>
          <div class="fg" style="margin-top:10px;">
            <div id="week-panel" class="panel" style="height:160px;">
              <div style="color:#7f8c8d;font-size:12px;">No weeks loaded yet</div>
            </div>
            <div class="hint">Select from uploaded files.</div>
          </div>
        </details>
      </div>

      <!-- Date Range -->
      <div class="block">
        <details open>
          <summary>Date Range</summary>
          <div class="fg" style="margin-top:10px; display:flex; flex-direction:row; gap:10px; flex-wrap:wrap;">
            <div class="fg" style="flex:1; min-width:160px;">
              <label style="font-size:12px; font-weight:600;">Start Date</label>
              <input type="date" id="ds" />
              <div class="hint">Auto-populated from CSVs.</div>
            </div>
            <div class="fg" style="flex:1; min-width:160px;">
              <label style="font-size:12px; font-weight:600;">End Date</label>
              <input type="date" id="de" />
              <div class="hint">Auto-populated from CSVs.</div>
            </div>
          </div>
        </details>
      </div>

      <!-- Fleet -->
      <div class="block small">
        <details open>
          <summary>Fleet</summary>
          <div class="fg" style="margin-top:10px;">
            <input id="fleet" list="fleet-list" style="padding:8px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px; background:#fff;" placeholder="Type to search or select...">
            <datalist id="fleet-list">
              <option value="">(all)</option>
            </datalist>
            <div class="hint">Type to search or select from list.</div>
          </div>
        </details>
      </div>

      <!-- Asset -->
      <div class="block small">
        <details open>
          <summary>Asset</summary>
          <div class="fg" style="margin-top:10px;">
            <select id="vehicle" style="padding:8px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px; background:#fff;">
              <option value="">(all)</option>
            </select>
            <div class="hint">Select vehicle.</div>
          </div>
        </details>
      </div>

      <!-- Classification Filter -->
      <div class="block wide" style="flex-basis: 100%;">
        <details open>
          <summary>Classification (updates Fleet KPIs + Fleet table)</summary>
          <div class="fg" style="margin-top:10px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
              <input id="class-search" type="text" placeholder="Search classification..." style="flex:1; min-width:160px; padding:8px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px;" />
              <button class="btn" type="button" id="class-all">Select All</button>
              <button class="btn" type="button" id="class-none">Clear</button>
            </div>
            <div id="class-panel" class="panel" style="height:160px;">
              <div style="color:#7f8c8d;font-size:12px;">Upload CSV(s) to load classifications</div>
            </div>
            <div class="hint">This filter updates Fleet KPIs + Fleet table (does not change Interventions/FOV).</div>
          </div>
        </details>
      </div>
    </div>

    <!-- Stats row (Fleet tab only) -->
    <div class="stats" id="statsRow">
      <div class="stat"><div class="label">Total Fleets</div><div class="value" id="s-fleets">0</div></div>
      <div class="stat"><div class="label">Total Vehicles</div><div class="value" id="s-veh">0</div></div>

      <!-- Option B addition: Total Events KPI toggle (Include FOV) -->
      <div class="stat">
        <div class="label">
          Total Events
          <label style="margin-left:8px; font-size:11px; color:#7f8c8d; text-transform:none; letter-spacing:0; font-weight:950;">
            <input type="checkbox" id="kpi-include-fov" style="vertical-align:middle; margin-right:6px;">
            Include FOV
          </label>
        </div>
        <div class="value" id="s-total">0</div>
      </div>

      <div class="stat"><div class="label">Valid Fatigue</div><div class="value" id="s-valid">0</div></div>
      <div class="stat"><div class="label">FOV Events</div><div class="value" id="s-fov">0</div></div>
      <div class="stat"><div class="label">Overall Precision</div><div class="value" id="s-prec">0.0%</div></div>
      <div class="stat"><div class="label">% Vehicles Updated</div><div class="value" id="s-updated">0%</div></div>
    </div>

    <!-- TAB 1: Fleet -->
    <div id="fleetTab" class="tabpage active">
      <div class="section-title">Fleet Management</div>

      <div class="controls" style="margin-bottom:14px;">
        <div class="block wide">
          <div class="fg">
            <label style="margin-bottom:10px;">Fleet Precision Zone</label>
            <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#2c3e50; font-weight:normal;">
                <input type="checkbox" class="zone-checkbox" data-zone="all" checked />
                <span>All</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#e74c3c; font-weight:normal;">
                <input type="checkbox" class="zone-checkbox" data-zone="red" />
                <span style="color:#e74c3c; font-weight:bold;">Red (&lt; 50%)</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#f39c12; font-weight:normal;">
                <input type="checkbox" class="zone-checkbox" data-zone="yellow" />
                <span style="color:#f39c12; font-weight:bold;">Yellow (50‚Äì59.9%)</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#27ae60; font-weight:normal;">
                <input type="checkbox" class="zone-checkbox" data-zone="green" />
                <span style="color:#27ae60; font-weight:bold;">Green (‚â• 60%)</span>
              </label>
            </div>
            <div class="hint">Select precision zones to filter fleets shown (and their vehicle rows).</div>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="sortable" data-col="fleet">Fleet / Vehicle</th>
              <th class="num sortable" data-col="total_events">Total</th>
              <th class="num sortable" data-col="valid_fatigue">Valid</th>
              <th class="num sortable" data-col="false_events">False</th>
              <th class="num sortable" data-col="fov_events">FOV</th>
              <th class="num sortable" data-col="precision">Precision</th>
              <th class="sortable" data-col="version_mix">Version</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="nodata" class="no-data">No data matches your current filters</div>
      </div>
    </div>

    <!-- TAB 2: Interventions -->
    <div id="interventionsTab" class="tabpage">
      <div class="section-title">Interventions ‚Äî CAP KPI (per vehicle, per shift, per calendar day)</div>

      <!-- KPI Summary Section -->
      <div class="int-header">
        <div class="int-kpi-title">CAP KPI Summary (current Network Filters)</div>
        <div class="kpi-grid" id="int-kpis"></div>
        <div class="int-footnote">
          <strong>Total Verified Valid Fatigue</strong> is the denominator. <strong>Emails</strong> cell is clickable (opens evidence + downloadable CSV).
        </div>
      </div>

      <!-- Filters Section -->
      <div class="controls" style="margin-bottom:14px;">
        <div class="block small">
          <div class="fg">
            <label>Max Calls / Shift (CAP)</label>
            <input type="text" id="int-cap-text" value="10" inputmode="numeric" />
            <div class="hint">
              Cap applied to <strong>verified valid fatigue</strong> per vehicle-shift per day.<br/>
              Calls = min(CAP, Verified). Emails = max(0, Verified ‚àí CAP).
            </div>
          </div>
        </div>

        <div class="block">
          <div class="fg">
            <label>Email Filter (updates Interventions KPIs + table)</label>
            <div class="btnrow" style="margin-top:8px; margin-bottom:8px;">
              <button class="btn" type="button" id="emails-all">Select All</button>
              <button class="btn" type="button" id="emails-none">Clear</button>
            </div>
            <div id="emails-panel" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
              <div style="color:#7f8c8d;font-size:12px;">Upload CSV(s) to enable email filtering</div>
            </div>
            <div class="hint">
              Red: <strong>&gt; 20</strong> ‚Ä¢ Yellow: <strong>10‚Äì20</strong> ‚Ä¢ Grey: <strong>&lt; 10</strong> ‚Ä¢ NA stays NA.
            </div>
          </div>
        </div>

        <div class="block">
          <div class="fg">
            <label style="margin-bottom:10px;">Zones</label>
            <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#2c3e50; font-weight:normal;">
                <input type="checkbox" class="int-zone-checkbox" data-zone="all" checked />
                <span>All</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#27ae60; font-weight:normal;">
                <input type="checkbox" class="int-zone-checkbox" data-zone="green" />
                <span style="color:#27ae60; font-weight:bold;">‚â• 60%</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#f39c12; font-weight:normal;">
                <input type="checkbox" class="int-zone-checkbox" data-zone="yellow" />
                <span style="color:#f39c12; font-weight:bold;">50% to 60%</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; margin:0; color:#e74c3c; font-weight:normal;">
                <input type="checkbox" class="int-zone-checkbox" data-zone="red" />
                <span style="color:#e74c3c; font-weight:bold;">&lt; 50%</span>
              </label>
            </div>
            <div class="hint">Select zones to filter interventions table rows.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Vehicle-shifts (sortable)</h3>
        <div class="subnote">
          A <strong>vehicle-shift</strong> is one vehicle on one calendar day in either <strong>Day (06:01‚Äì19:59)</strong> or <strong>Night (20:00‚Äì06:00)</strong>.
          <br/>
          <strong>Total Events</strong> includes all events in that vehicle-shift after Network Filters. <strong>Verified Valid Fatigue</strong> includes verified microsleep + verified drowsiness only.
          <br/>
          <strong>Cap‚ÜíEmail Miles</strong> uses straight-line (haversine) distance from the CAP event location to the last email-event location (when both have lat/lon).
        </div>

        <div class="table-wrap" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-icol="dateISO">Date</th>
                <th class="sortable" data-icol="shift">Shift</th>
                <th class="sortable" data-icol="fleet">Fleet</th>
                <th class="sortable" data-icol="vehicle">Vehicle</th>
                <th class="num sortable" data-icol="total_events">Total Events</th>
                <th class="num sortable" data-icol="verified_total">Verified Valid Fatigue</th>
                <th class="num sortable" data-icol="calls">Calls</th>
                <th class="num sortable" data-icol="emails">Emails</th>
                <th class="sortable" data-icol="cap_time">Last CAP Call</th>
                <th class="sortable" data-icol="last_email_time">Last Email Time</th>
                <th class="num sortable" data-icol="cap_lat">CAP Lat</th>
                <th class="num sortable" data-icol="cap_lon">CAP Lon</th>
                <th class="num sortable" data-icol="email_lat">Email Lat</th>
                <th class="num sortable" data-icol="email_lon">Email Lon</th>
                <th class="num sortable" data-icol="cap_to_email_miles">Cap‚ÜíEmail Miles</th>
                <th class="sortable" data-icol="software_version">Software Version</th>
              </tr>
            </thead>
            <tbody id="int-body"></tbody>
          </table>
          <div id="int-nodata" class="no-data">Upload CSV(s) to view interventions</div>
        </div>
      </div>
    </div>

    <!-- TAB 3: FOV -->
    <div id="fovTab" class="tabpage">
      <div class="section-title">FOV ‚Äî Camera Misaligned</div>

      <div class="controls" style="margin-bottom:14px;">
        <div class="block small">
          <div class="fg">
            <label>Filter by Proximity Risk (hide other rows)</label>
            <select id="fov-gap-filter">
              <option value="all" selected>All</option>
              <option value="red">Red (‚â§ 1 hour)</option>
              <option value="yellow">Yellow (‚â§ 24 hours)</option>
              <option value="green">Green (&gt; 24 hours)</option>
              <option value="na">N/A (no prior verified fatigue)</option>
            </select>
            <div class="hint">
              Applies to <strong>Proximity Gap</strong> (last prior verified fatigue ‚Üí first misaligned event). Rows not matching are hidden.
            </div>
          </div>
        </div>

        <div class="block">
          <div class="fg">
            <label>FOV Summary (current Network Filters)</label>
            <div class="kpi-grid" id="fov-kpis"></div>
            <div class="hint" style="margin-top:8px;">
              <strong>Proximity Gap</strong> colors indicate how close the last verified fatigue was before the first misalignment (possible proximity/tamper signal).
              <br/>
              <strong>Exposure</strong> indicates how long the camera remained misaligned (unmonitored window).
              <br/>
              <strong>Last Verified Fatigue</strong> is highlighted <span class="chip chip-green">Green</span> only when the most recent <strong>verified fatigue</strong> event is <strong>after</strong> the latest misaligned event (camera likely fixed).
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>FOV Exception ‚Äî Camera Misaligned (sortable)</h3>
        <div class="subnote">
          Click <strong>Verified Fatigue Before / Last Verified Fatigue / First FOV / Latest FOV</strong> to open evidence and download.
        </div>

        <div class="table-wrap" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-fcol="vehicle_id">Vehicle ID</th>
                <th class="sortable" data-fcol="fleet">Fleet</th>
                <th class="sortable" data-fcol="vehicle">Vehicle</th>
                <th class="num sortable" data-fcol="events_count">Events Count</th>
                <th class="num sortable" data-fcol="verified_before">Verified Fatigue Before</th>
                <th class="sortable" data-fcol="last_verified_ms">Last Verified Fatigue</th>
                <th class="sortable" data-fcol="gap_bucket">Proximity Gap</th>
                <th class="sortable" data-fcol="exposure_bucket">Exposure</th>
                <th class="sortable" data-fcol="first_fov_ms">First FOV</th>
                <th class="sortable" data-fcol="latest_fov_ms">Latest FOV</th>
              </tr>
            </thead>
            <tbody id="fov-body"></tbody>
          </table>
          <div id="fov-nodata" class="no-data">Upload CSV(s) to view FOV camera misaligned rows</div>
        </div>
      </div>
    </div>

    <!-- TAB 4: Trends -->
    <div id="trendsTab" class="tabpage">
      <div class="section-title">Trends ‚Äî Executive Dashboard & Fleet Analytics</div>

      <!-- Executive Summary Section -->
      <div class="card" style="margin-bottom:14px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3 style="margin:0; color:#2c3e50; font-size:18px; font-weight:1000;">üìà Executive Summary</h3>
          <label style="display:flex; align-items:center; font-size:12px; color:#666; cursor:pointer;">
            <input type="checkbox" id="trends-aggregate-toggle" checked style="margin-right:6px;">
            <span>Aggregate All Selected Weeks</span>
          </label>
        </div>
        <div id="trends-summary" class="kpi-grid">
          <!-- Dynamic summary cards will be injected here -->
        </div>
      </div>

      <!-- Fleet Distribution & Trend Chart -->
      <div class="card" style="margin-bottom:14px;">
        <h3 style="margin-bottom:10px; color:#2c3e50; font-size:16px; font-weight:1000;">üìä Network Performance Overview</h3>
        <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:14px;">
          <!-- Fleet Distribution Chart -->
          <div style="flex:1; min-width:300px;">
            <div style="font-size:13px; font-weight:700; color:#2c3e50; margin-bottom:10px;">Fleet Distribution by Performance Zone</div>
            <div id="trends-distribution-chart" style="min-height:100px;">
              <!-- Chart will be rendered here -->
            </div>
          </div>
          <!-- Precision Trend Chart -->
          <div style="flex:2; min-width:400px;">
            <div style="font-size:13px; font-weight:700; color:#2c3e50; margin-bottom:10px; text-align:center;">Network Precision Trend (All Weeks)</div>
            <div id="trends-precision-chart" style="min-height:100px;">
              <!-- Chart will be rendered here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Leaders Section -->
      <div class="card" style="margin-bottom:14px; background:#fff9e6; border-left:4px solid #f39c12;">
        <h3 style="margin-bottom:10px; color:#2c3e50; font-size:16px; font-weight:1000;">‚≠ê Performance Leaders</h3>
        <div style="color:#34495e; font-size:13px; line-height:1.45; margin-bottom:10px;">
          Fleets with 60% or greater Valid Fatigue Alert precision in the current week.
        </div>
        <div class="table-wrap">
          <table>
            <thead id="trends-leaders-thead">
              <tr>
                <th class="num sortable" data-tleaders="rank">Rank</th>
                <th class="sortable" data-tleaders="fleet">Fleet</th>
                <th class="num sortable" data-tleaders="prevPrec">Previous %</th>
                <th class="num sortable" data-tleaders="currPrec">Current %</th>
                <th class="num sortable" data-tleaders="delta">Change</th>
              </tr>
            </thead>
            <tbody id="trends-leaders-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- 2-Column Layout: Best Performers and Declining Fleets Side-by-Side -->
      <div style="display:flex; gap:14px; flex-wrap:wrap; margin-bottom:14px;">
        <!-- Most Improved Fleets -->
        <div class="card" style="flex:1; min-width:420px; background:#f0fff4; border-left:4px solid #27ae60;">
          <h3 style="margin-bottom:10px; color:#2c3e50; font-size:16px; font-weight:1000;">üèÜ Most Improved Fleets (Previous vs Current Week)</h3>
          <div style="color:#34495e; font-size:13px; line-height:1.45; margin-bottom:10px;">
            Fleets showing greatest positive change in Valid Fatigue Alerts (%) from the previous week.
          </div>
          <div class="table-wrap">
            <table>
              <thead id="trends-best-thead">
                <tr>
                  <th class="num sortable" data-tbest="rank">Rank</th>
                  <th class="sortable" data-tbest="fleet">Fleet</th>
                  <th class="num sortable" data-tbest="prevPrec">Previous %</th>
                  <th class="num sortable" data-tbest="currPrec">Current %</th>
                  <th class="num sortable" data-tbest="delta">Improvement</th>
                </tr>
              </thead>
              <tbody id="trends-best-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Most Declined Fleets -->
        <div class="card" style="flex:1; min-width:420px; background:#fff5f5; border-left:4px solid #e74c3c;">
          <h3 style="margin-bottom:10px; color:#2c3e50; font-size:16px; font-weight:1000;">‚ö†Ô∏è Most Declined Fleets (Previous vs Current Week)</h3>
          <div style="color:#34495e; font-size:13px; line-height:1.45; margin-bottom:10px;">
            Fleets showing greatest negative change in Valid Fatigue Alerts (%) from the previous week.
          </div>
          <div class="table-wrap">
            <table>
              <thead id="trends-worst-thead">
                <tr>
                  <th class="num sortable" data-tworst="rank">Rank</th>
                  <th class="sortable" data-tworst="fleet">Fleet</th>
                  <th class="num sortable" data-tworst="prevPrec">Previous %</th>
                  <th class="num sortable" data-tworst="currPrec">Current %</th>
                  <th class="num sortable" data-tworst="delta">Decline</th>
                </tr>
              </thead>
              <tbody id="trends-worst-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 2-Column Layout: Weekly Trends and Volume Changes Side-by-Side -->
      <div style="display:flex; gap:14px; flex-wrap:wrap; margin-bottom:14px;">
        <!-- Weekly Overview -->
        <div class="card" id="trends-weekly-section" style="flex:1; min-width:420px;">
          <h3 style="margin-bottom:10px; color:#2c3e50; font-size:16px; font-weight:1000;">üìÖ Weekly Precision Trends</h3>
          <div style="color:#34495e; font-size:13px; line-height:1.45; margin-bottom:10px;">
            Total events (Excl. FOV &amp; Valid).
          </div>
          <div class="table-wrap">
            <table>
              <thead id="trends-weekly-thead">
                <tr>
                  <th class="sortable" data-tweekly="week">Week</th>
                  <th class="num sortable" data-tweekly="total">Total Events</th>
                  <th class="num sortable" data-tweekly="valid">Valid Fatigue</th>
                  <th class="num sortable" data-tweekly="precision">Precision %</th>
                  <th class="num sortable" data-tweekly="delta">Œî WoW</th>
                </tr>
              </thead>
              <tbody id="trends-weekly-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Volume Trends -->
        <div class="card" style="flex:1; min-width:420px;">
          <h3 style="margin-bottom:10px; color:#2c3e50; font-size:16px; font-weight:1000;">üìä Activity Changes</h3>
          <div style="color:#34495e; font-size:13px; line-height:1.45; margin-bottom:10px;">
            Fleets with largest changes in event volume.
          </div>
          
          <!-- Activity Type Filter Checkboxes -->
          <div style="margin-bottom:12px; padding:10px; background:#f8f9fa; border-radius:6px; border:1px solid #e0e0e0;">
            <div style="font-weight:600; font-size:13px; color:#2c3e50; margin-bottom:8px;">Filter by Event Type:</div>
            <div style="display:flex; gap:16px; flex-wrap:wrap;">
              <label style="display:flex; align-items:center; cursor:pointer; font-size:13px;">
                <input type="checkbox" id="trends-vol-total" checked style="margin-right:6px; cursor:pointer;">
                Total Events (excl. FOV & Valid)
              </label>
              <label style="display:flex; align-items:center; cursor:pointer; font-size:13px;">
                <input type="checkbox" id="trends-vol-fov" checked style="margin-right:6px; cursor:pointer;">
                FOV Misaligned Events
              </label>
              <label style="display:flex; align-items:center; cursor:pointer; font-size:13px;">
                <input type="checkbox" id="trends-vol-valid" checked style="margin-right:6px; cursor:pointer;">
                Valid Alerts
              </label>
            </div>
          </div>
          
          <div class="table-wrap">
            <table>
              <thead id="trends-volume-thead">
                <tr>
                  <th class="sortable" data-tvol="fleet">Fleet</th>
                  <th class="num sortable" data-tvol="prevTotal">Previous Week</th>
                  <th class="num sortable" data-tvol="currTotal">Current Week</th>
                  <th class="num sortable" data-tvol="change">Change</th>
                  <th class="num sortable" data-tvol="changePercent">Change %</th>
                </tr>
              </thead>
              <tbody id="trends-volume-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- No Data Message -->
      <div id="trends-nodata" class="no-data">Upload CSV(s) with at least 2 weeks to view trends</div>
    </div>

    <!-- TAB 5: How To -->
    <div id="howTab" class="tabpage">
      <div class="section-title">How To (Event Logic + Interventions + FOV Column Explanations)</div>

      <div class="card">
        <h3>Event Categories (used in totals)</h3>
        <div style="color:#34495e; font-size:13px; line-height:1.45;">
          <ul style="padding-left:18px; margin-top:6px;">
            <li><strong>Total Events</strong> = all rows after network filters (week/date/fleet/vehicle). (Fleet tab can further filter by Classification)</li>
            <li><strong>Valid Fatigue</strong> = classification is <code>fatigue - drowsiness</code> or <code>fatigue - microsleep</code> AND confirmation is <code>verified</code></li>
            <li><strong>False Events</strong> = classification is <code>fatigue - criteria not met</code></li>
            <li><strong>FOV Events</strong> = event_type is <code>field of view exception</code> OR classification starts with <code>FOV exception</code></li>
            <li><strong>Precision %</strong> = <strong>Valid Fatigue</strong> / (<strong>Total Events ‚àí FOV Events</strong>) √ó 100</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h3>Interventions (CAP KPI) Logic</h3>
        <div style="color:#34495e; font-size:13px; line-height:1.55;">
          <ul style="padding-left:18px; margin-top:6px;">
            <li>Grouping is <strong>per vehicle, per shift, per calendar day</strong>.</li>
            <li>Only <strong>verified valid fatigue</strong> events count toward Calls/Emails.</li>
            <li>Shift windows:
              <ul style="padding-left:18px; margin-top:6px;">
                <li><strong>Day</strong>: 06:01‚Äì19:59</li>
                <li><strong>Night</strong>: 20:00‚Äì06:00</li>
              </ul>
            </li>
            <li>First <strong>CAP</strong> verified fatigue events are assumed <strong>Calls</strong>.</li>
            <li>Verified fatigue events <strong>after CAP</strong> are assumed <strong>Emails</strong> (click Emails to view evidence + download).</li>
            <li><strong>Total Events</strong> column = all events in that vehicle-shift after Network Filters.</li>
            <li>KPI %s use <strong>Total Verified Valid Fatigue</strong> as the denominator.</li>
            <li><strong>Cap‚ÜíEmail Miles</strong> = straight-line distance (haversine) between CAP event coordinate and last email-event coordinate (when both exist).</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h3>FOV Column Explanations (Camera Misaligned)</h3>
        <div style="color:#34495e; font-size:13px; line-height:1.55;">
          <ul style="padding-left:18px; margin-top:6px;">
            <li><strong>Misaligned-only FOV logic</strong>: first/latest FOV + exposure + count are computed only from <code>FOV exception - camera misaligned</code>.</li>
            <li><strong>Verified fatigue logic</strong> on this tab:
              <ul style="padding-left:18px; margin-top:6px;">
                <li>Verified fatigue includes <code>fatigue - microsleep</code> and <code>fatigue - drowsiness</code> with <code>confirmation=verified</code>.</li>
              </ul>
            </li>
            <li><strong>Proximity Gap</strong> = last prior verified fatigue ‚Üí first misaligned event.</li>
            <li><strong>Exposure</strong> = latest misaligned event ‚àí first misaligned event (how long the vehicle operated without fatigue monitoring).</li>
            <li><strong>Last Verified Fatigue</strong> is green-highlighted when it occurs after the latest misaligned event (camera likely fixed).</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Evidence Modal -->
    <div class="modal-backdrop" id="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="modal-title">Evidence</div>
            <div class="modal-sub" id="modal-sub"></div>
          </div>
          <div class="modal-actions">
            <button class="modal-btn" id="modal-download">Download CSV</button>
            <button class="modal-close" id="modal-close">Close</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="small-table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Week</th>
                  <th>Date</th>
                  <th>Detection Time</th>
                  <th>Event ID</th>
                  <th>Fleet</th>
                  <th>Vehicle</th>
                  <th>Classification</th>
                  <th>Event Type</th>
                  <th>Confirmation</th>
                  <th>Lat</th>
                  <th>Lon</th>
                  <th>Software</th>
                </tr>
              </thead>
              <tbody id="modal-body-rows"></tbody>
            </table>
          </div>
          <div class="mini" id="modal-foot" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <script>
/* =======================================================================================
   SECTION: Persistence (IndexedDB for data, localStorage for UI state)
======================================================================================= */
const LS_KEY = 'fleetDash_UI_v3';
const IDB_NAME = 'fleetDashDB_v3';
const IDB_STORE = 'events';

function idbOpen(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(IDB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(IDB_STORE)){
        db.createObjectStore(IDB_STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbSet(key, val){
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put(val, key);
    tx.oncomplete = () => { db.close(); resolve(); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}
async function idbGet(key){
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readonly');
    const req = tx.objectStore(IDB_STORE).get(key);
    req.onsuccess = () => { db.close(); resolve(req.result); };
    req.onerror = () => { db.close(); reject(req.error); };
  });
}
async function idbClear(){
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).clear();
    tx.oncomplete = () => { db.close(); resolve(); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}

let persistTimer = null;
function schedulePersist(){
  clearTimeout(persistTimer);
  persistTimer = setTimeout(() => { persistAll().catch(()=>{}); }, 500);
}

function uiSnapshot(){
  // Get collapsible filter states
  const collapsibleStates = {};
  document.querySelectorAll('.controls details').forEach((details, idx) => {
    const summary = details.querySelector('summary');
    if(summary) {
      const key = summary.textContent.trim().substring(0, 30); // Use first 30 chars as key
      collapsibleStates[key] = details.open;
    }
  });
  
  return {
    activeTab: document.querySelector('.tabbtn.active')?.getAttribute('data-tab') || 'fleetTab',
    weeks: Array.from(selectedWeeks),
    weeksManuallyChanged,
    classes: Array.from(selectedClasses),
    classesManuallyChanged,
    expandedFleets: Array.from(expandedFleets),

    emailBuckets: Array.from(selectedEmailBuckets),
    emailsManuallyChanged,

    // reportWeek removed - now using weeks array for checkbox state
    fleet: document.getElementById('fleet').value,
    vehicle: document.getElementById('vehicle').value,
    ds: document.getElementById('ds').value,
    de: document.getElementById('de').value,

    fleetPrecZones: Array.from(document.querySelectorAll('.zone-checkbox:checked')).map(cb => cb.dataset.zone),
    fovGap: document.getElementById('fov-gap-filter').value,

    intCapText: document.getElementById('int-cap-text').value,

    // Option B: persist Total Events KPI toggle
    includeFovInTotalKpi: !!document.getElementById('kpi-include-fov')?.checked,
    
    // Trends aggregation mode toggle
    trendsAggregateMode,
    
    // Collapsible filter states
    collapsibleStates,

    sortState,
    fovSort,
    intSort,
    trendsBestSort,
    trendsWorstSort,
    trendsLeadersSort,
    trendsWeeklySort,
    trendsVolumeSort
  };
}
function applyUiSnapshot(s){
  if(!s) return;

  if(s.activeTab) setActiveTab(s.activeTab);

  // reportWeek dropdown removed - now using weeks checkboxes
  
  // Restore fleet input value (now using input with datalist)
  if(typeof s.fleet === 'string') {
    document.getElementById('fleet').value = s.fleet;
  }
  
  if(typeof s.vehicle === 'string') document.getElementById('vehicle').value = s.vehicle;
  if(typeof s.ds === 'string') document.getElementById('ds').value = s.ds;
  if(typeof s.de === 'string') document.getElementById('de').value = s.de;

  // Restore fleet precision zones
  if(Array.isArray(s.fleetPrecZones)) {
    document.querySelectorAll('.zone-checkbox').forEach(cb => {
      cb.checked = s.fleetPrecZones.includes(cb.dataset.zone);
    });
  }
  if(typeof s.fovGap === 'string') document.getElementById('fov-gap-filter').value = s.fovGap;
  if(typeof s.intCapText === 'string') document.getElementById('int-cap-text').value = s.intCapText;

  if(Array.isArray(s.weeks)) selectedWeeks = new Set(s.weeks);
  if(typeof s.weeksManuallyChanged === 'boolean') weeksManuallyChanged = s.weeksManuallyChanged;
  if(Array.isArray(s.classes)) selectedClasses = new Set(s.classes);
  if(typeof s.classesManuallyChanged === 'boolean') classesManuallyChanged = s.classesManuallyChanged;
  if(Array.isArray(s.expandedFleets)) expandedFleets = new Set(s.expandedFleets);

  if(Array.isArray(s.emailBuckets)) selectedEmailBuckets = new Set(s.emailBuckets);
  if(typeof s.emailsManuallyChanged === 'boolean') emailsManuallyChanged = s.emailsManuallyChanged;

  if(typeof s.includeFovInTotalKpi === 'boolean'){
    const cb = document.getElementById('kpi-include-fov');
    if(cb) cb.checked = s.includeFovInTotalKpi;
  }
  
  if(typeof s.trendsAggregateMode === 'string'){
    trendsAggregateMode = s.trendsAggregateMode;
    const toggle = document.getElementById('trends-aggregate-toggle');
    if(toggle) toggle.checked = (trendsAggregateMode === 'all');
  }
  
  // Restore collapsible filter states
  if(s.collapsibleStates && typeof s.collapsibleStates === 'object') {
    document.querySelectorAll('.controls details').forEach((details) => {
      const summary = details.querySelector('summary');
      if(summary) {
        const key = summary.textContent.trim().substring(0, 30);
        if(key in s.collapsibleStates) {
          details.open = s.collapsibleStates[key];
        }
      }
    });
  }

  if(s.sortState) sortState = s.sortState;
  if(s.fovSort) fovSort = s.fovSort;
  if(s.intSort) intSort = s.intSort;
  if(s.trendsBestSort) trendsBestSort = s.trendsBestSort;
  if(s.trendsWorstSort) trendsWorstSort = s.trendsWorstSort;
  if(s.trendsLeadersSort) trendsLeadersSort = s.trendsLeadersSort;
  if(s.trendsWeeklySort) trendsWeeklySort = s.trendsWeeklySort;
  if(s.trendsVolumeSort) trendsVolumeSort = s.trendsVolumeSort;
}
async function persistAll(){
  await idbSet('rawEvents', rawEvents);
  localStorage.setItem(LS_KEY, JSON.stringify(uiSnapshot()));
}
async function restoreAll(){
  try{
    const data = await idbGet('rawEvents');
    if(Array.isArray(data) && data.length){
      rawEvents = data;
      // File status removed: document.getElementById('file-status').textContent = `${rawEvents.length.toLocaleString()} events`;
    }
  }catch(_){}
  try{
    const s = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    if(s) applyUiSnapshot(s);
  }catch(_){}
}

/* =======================================================================================
   SECTION: State
======================================================================================= */
let rawEvents = [];
let selectedWeeks = new Set();
let weeksManuallyChanged = false;

let selectedClasses = new Set();
let classesManuallyChanged = false;

let selectedEmailBuckets = new Set();   // 'red','yellow','grey','na'
let emailsManuallyChanged = false;

// Trends aggregation mode: 'all' = all selected weeks, 'latest' = latest week only
let trendsAggregateMode = 'all';

let expandedFleets = new Set();

let sortState = { col:null, dir:'asc' }; // fleet tab sort
let fovSort = { col:'events_count', dir:'desc' };
let intSort = { col:'verified_total', dir:'desc' };
let trendsBestSort = { col:'delta', dir:'desc' }; // Trends Best Performers table
let trendsWorstSort = { col:'delta', dir:'asc' }; // Trends Declining Fleets table (asc because negative deltas)
let trendsLeadersSort = { col:'currPrec', dir:'desc' }; // Trends Performance Leaders table
let trendsWeeklySort = { col:null, dir:'asc' }; // Trends Weekly table
let trendsVolumeSort = { col:'change', dir:'desc' }; // Trends Volume table

let latestVersionStr = null;

let currentFilteredEvents = [];         // Network + Classification (Fleet table & Fleet drilldowns)
let currentNetworkFilteredEvents = [];  // Network only (KPIs + Interventions + FOV)
let fleetAggByName = new Map();
let vehicleAggByKey = new Map();
let fovRowByKey = new Map();
let intRowByKey = new Map();

let modalRowsCache = [];
let modalDownloadName = 'evidence.csv';

/* =======================================================================================
   SECTION: Helpers
======================================================================================= */
function esc(s){
  return String(s ?? '')
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function showError(msg){
  const el = document.getElementById('error');
  if(!msg){ el.style.display='none'; el.innerHTML=''; return; }
  el.style.display='block';
  el.innerHTML = `CSV load failed: <code>${esc(msg)}</code>`;
}
function precisionClass(p){
  if(p < 50) return 'prec-bad';
  if(p < 60) return 'prec-warn';
  return 'prec-good';
}
function precisionBucket(p){
  if(p < 50) return 'red';
  if(p < 60) return 'yellow';
  return 'green';
}
function fmtDateTime(ms){
  if(!Number.isFinite(ms)) return 'N/A';
  const d = new Date(ms);
  const yyyy = d.getFullYear();
  const MM = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${yyyy}-${MM}-${dd} ${hh}:${mm}:${ss}`;
}
function formatHMS(totalSeconds){
  if(!Number.isFinite(totalSeconds) || totalSeconds < 0) return 'N/A';
  const s = Math.floor(totalSeconds);
  const days = Math.floor(s / 86400);
  const rem = s % 86400;
  const hh = String(Math.floor(rem / 3600)).padStart(2,'0');
  const mm = String(Math.floor((rem % 3600) / 60)).padStart(2,'0');
  const ss = String(rem % 60).padStart(2,'0');
  return days > 0 ? `${days}d ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
}
function gapBucketFromSeconds(sec){
  if(!Number.isFinite(sec)) {
    console.warn("[gapBucketFromSeconds] Invalid gap_seconds provided:", sec);
    return 'na'; // Default to N/A for invalid or missing data
  }
  if(sec <= 3600) return 'red';      // ‚â§1 hour gap
  if(sec <= 86400) return 'yellow';  // ‚â§24 hours gap
  return 'green';                     // >24 hours gap
}
function exposureBucketFromSeconds(sec){
  if(!Number.isFinite(sec)) return 'na';
  if(sec <= 3600) return 'green';
  if(sec <= 86400) return 'yellow';
  return 'red';
}
function gapChipHTML(bucket, label){
  if(bucket === 'red') return `<span class="chip chip-red">${esc(label)}</span>`;
  if(bucket === 'yellow') return `<span class="chip chip-yellow">${esc(label)}</span>`;
  if(bucket === 'green') return `<span class="chip chip-green">${esc(label)}</span>`;
  return `<span class="chip chip-na">N/A</span>`;
}
function shiftLabel(ms){
  if(!Number.isFinite(ms)) return 'N/A';
  const d = new Date(ms);
  const h = d.getHours();
  const m = d.getMinutes();
  const isDay = (h > 6 && h < 20) || (h === 6 && m >= 1) || (h === 19 && m <= 59);
  return isDay ? 'Day' : 'Night';
}

/* Haversine distance (miles) */
function haversineMiles(lat1, lon1, lat2, lon2){
  if(!Number.isFinite(lat1) || !Number.isFinite(lon1) || !Number.isFinite(lat2) || !Number.isFinite(lon2)) return null;
  const R = 3958.7613;
  const toRad = (deg) => deg * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* semver-ish compare */
function parseVersion(v){
  const s = String(v ?? '').trim();
  if(!s) return null;
  const parts = s.split('.').map(x => parseInt(x,10));
  if(parts.some(n => !Number.isFinite(n))) return null;
  return parts;
}
function cmpVersion(aStr, bStr){
  const a = parseVersion(aStr);
  const b = parseVersion(bStr);
  if(!a && !b) return 0;
  if(!a) return -1;
  if(!b) return 1;
  const n = Math.max(a.length, b.length);
  for(let i=0;i<n;i++){
    const av = a[i] ?? 0;
    const bv = b[i] ?? 0;
    if(av !== bv) return av - bv;
  }
  return 0;
}
function versionBadgeHTML(v, isLatest){
  const s = String(v ?? '').trim();
  if(!s) return `<span class="badge ver-badge ver-na">N/A</span>`;
  const cls = isLatest ? 'ver-up' : 'ver-old';
  return `<span class="badge ver-badge ${cls}">${esc(s)}${isLatest ? ' ‚úì':''}</span>`;
}

/* Interventions email bucket (requested thresholds) */
function emailBucketFromCount(n){
  if(n == null || !Number.isFinite(Number(n))) return 'na';
  const x = Number(n);
  if(x > 20) return 'red';
  if(x >= 10) return 'yellow';     // 10‚Äì20
  return 'grey';                   // <10
}
function emailChipHTML(n, isClickable, key){
  const b = emailBucketFromCount(n);
  const val = (n == null || !Number.isFinite(Number(n))) ? 'N/A' : Number(n).toLocaleString();
  const cls =
    b === 'red' ? 'email-chip email-high' :
    b === 'yellow' ? 'email-chip email-med' :
    b === 'grey' ? 'email-chip email-low' : 'email-chip email-na';

  if(isClickable){
    return `<span class="${cls} link" data-intdrill="emails" data-key="${esc(key)}" title="Click to view email events">${esc(val)}</span>`;
  }
  return `<span class="${cls}">${esc(val)}</span>`;
}

/* =======================================================================================
   SECTION: Tabs
======================================================================================= */
function setActiveTab(tabId){
  document.querySelectorAll('.tabpage').forEach(p => p.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('.tabbtn').forEach(b => b.classList.remove('active'));
  const btn = document.querySelector(`.tabbtn[data-tab="${CSS.escape(tabId)}"]`);
  if(btn) btn.classList.add('active');

  document.getElementById('statsRow').style.display = (tabId === 'fleetTab') ? 'flex' : 'none';
  
  // Hide Upload CSV section and Advanced Classification Filter when Trends tab is active
  const uploadBlock = document.querySelector('.block.small');
  const advFilter = document.getElementById('adv');
  if (tabId === 'trendsTab') {
    if (uploadBlock) uploadBlock.style.display = 'none';
    if (advFilter) advFilter.style.display = 'none';
  } else {
    if (uploadBlock) uploadBlock.style.display = '';
    if (advFilter) advFilter.style.display = '';
  }
  
  schedulePersist();
}
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.tabbtn');
  if(btn){ setActiveTab(btn.getAttribute('data-tab')); return; }
});
// goHow link removed from UI

/* =======================================================================================
   SECTION: CSV parsing
======================================================================================= */
function parseCSV(text){
  text = text.replace(/^\uFEFF/, '');
  const rows = [];
  let row = [];
  let cur = '';
  let inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const nx = text[i+1];
    if(ch === '"' && inQ && nx === '"'){ cur += '"'; i++; continue; }
    if(ch === '"'){ inQ = !inQ; continue; }
    if(ch === ',' && !inQ){ row.push(cur); cur=''; continue; }
    if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && nx === '\n') i++;
      row.push(cur);
      if(row.some(c => String(c).trim() !== '')) rows.push(row);
      row=[]; cur='';
      continue;
    }
    cur += ch;
  }
  if(cur.length || row.length){
    row.push(cur);
    if(row.some(c => String(c).trim() !== '')) rows.push(row);
  }
  return rows;
}
function normHeader(h){
  return String(h ?? '').trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
}
function parseDetectionTime(dt){
  const s = String(dt || '').trim();
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?/);
  if(m){
    const yyyy = +m[1], MM = +m[2], dd = +m[3];
    const hh = m[4] ? +m[4] : 0;
    const mm = m[5] ? +m[5] : 0;
    const ss = m[6] ? +m[6] : 0;
    const d = new Date(yyyy, MM-1, dd, hh, mm, ss);
    const dateISO = `${m[1]}-${m[2]}-${m[3]}`;
    return { dateISO, ms: d.getTime() };
  }
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
  if(m){
    const MM = +m[1], dd = +m[2], yyyy = +m[3];
    const hh = m[4] ? +m[4] : 0;
    const mm = m[5] ? +m[5] : 0;
    const ss = m[6] ? +m[6] : 0;
    const d = new Date(yyyy, MM-1, dd, hh, mm, ss);
    const dateISO = `${String(yyyy).padStart(4,'0')}-${String(MM).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    return { dateISO, ms: d.getTime() };
  }
  return null;
}
function fileNameToWeekKey(fileName){
  const n = String(fileName || '').toLowerCase();
  const m = n.match(/(20\d{2})\s*week\s*(\d{1,2})/i) || n.match(/(20\d{2})week\s*(\d{1,2})/i);
  if(!m) return null;
  const year = m[1];
  const wk = String(parseInt(m[2],10)).padStart(2,'0');
  return `${year}-W${wk}`;
}
function loadEventsFromCSV(csvText, fileWeekKey){
  const grid = parseCSV(csvText);
  if(grid.length < 2) throw new Error("CSV has no data rows.");

  const headersRaw = grid[0].map(h => String(h ?? '').trim());
  const headers = headersRaw.map(normHeader);
  const idx = (name) => headers.indexOf(normHeader(name));

  const iEvent = idx('event_id');
  const iVehId = idx('vehicle_id');
  const iVeh = idx('vehicle');
  const iFleet = idx('fleet');
  const iDT = idx('detection_time');
  const iClass = idx('classification');
  const iType = idx('event_type');
  const iConf = idx('confirmation');
  const iDur = idx('duration_seconds');
  const iLat = idx('latitude');
  const iLon = idx('longitude');
  const iSoft = idx('software_version');

  const missing = [];
  if(iEvent === -1) missing.push('event_id');
  if(iVeh === -1) missing.push('vehicle');
  if(iFleet === -1) missing.push('fleet');
  if(iDT === -1) missing.push('detection_time');
  if(iClass === -1) missing.push('classification');
  if(iType === -1) missing.push('event_type');
  if(iConf === -1) missing.push('confirmation');
  if(missing.length){
    throw new Error(`Missing required columns: ${missing.join(', ')}. Found: ${headersRaw.join(', ')}`);
  }

  const out = [];
  for(let r=1;r<grid.length;r++){
    const row = grid[r];
    const get = (i) => (i >= 0 && i < row.length) ? row[i] : '';

    const event_id = String(get(iEvent)).trim();
    const vehicle_id = (iVehId >= 0) ? String(get(iVehId)).trim() : '';
    const vehicle = String(get(iVeh)).trim();
    const fleet = String(get(iFleet)).trim();
    const dt_raw = String(get(iDT)).trim();
    const classification = String(get(iClass)).trim();
    const event_type = String(get(iType)).trim();
    const confirmation = String(get(iConf)).trim();
    const duration_seconds = (iDur >= 0) ? Number(String(get(iDur)).trim()) : 0;
    const latitude = (iLat >= 0) ? Number(String(get(iLat)).trim()) : NaN;
    const longitude = (iLon >= 0) ? Number(String(get(iLon)).trim()) : NaN;
    const software_version = (iSoft >= 0) ? String(get(iSoft)).trim() : '';

    if(!event_id || !vehicle || !fleet || !dt_raw) continue;
    const parsed = parseDetectionTime(dt_raw);
    if(!parsed) continue;

    out.push({
      event_id, vehicle_id, vehicle, fleet,
      dateISO: parsed.dateISO, dt_raw, dt_ms: parsed.ms,
      classification, event_type, confirmation,
      duration_seconds: Number.isFinite(duration_seconds) ? duration_seconds : 0,
      latitude: Number.isFinite(latitude) ? latitude : null,
      longitude: Number.isFinite(longitude) ? longitude : null,
      software_version,
      fileWeek: fileWeekKey || 'Unknown'
    });
  }

  if(!out.length){
    const sample = (grid[1] ? grid[1].join(',').slice(0,200) : '');
    throw new Error(`Parsed CSV but got 0 usable rows (check detection_time formatting). Sample: ${sample}`);
  }
  return out;
}

/* ===== REQUIRED: Dedupe based on event_id (Option B requirement) ===== */
function dedupeAll(events){
  const byId = new Map();
  for(const e of events){
    const id = String(e.event_id || '').trim();
    if(!id) continue;

    if(!byId.has(id)){
      byId.set(id, e);
      continue;
    }
    // keep the newest timestamp if duplicates share the same event_id
    const cur = byId.get(id);
    const curMs = Number.isFinite(cur?.dt_ms) ? cur.dt_ms : -Infinity;
    const newMs = Number.isFinite(e?.dt_ms) ? e.dt_ms : -Infinity;
    if(newMs > curMs) byId.set(id, e);
  }
  return Array.from(byId.values());
}

/* =======================================================================================
   SECTION: Event logic
======================================================================================= */
function classifyEvent(e){
  const c = (e.classification || '').toLowerCase().trim();
  const t = (e.event_type || '').toLowerCase().trim();
  const conf = (e.confirmation || '').toLowerCase().trim();

  const isFov =
    t.includes('field of view') || t.includes('fov') ||
    c.includes('field of view') || c.startsWith('fov exception');

  const isValidFatigue =
    (c === 'fatigue - drowsiness' || c === 'fatigue - microsleep') &&
    (conf === 'verified');

  const isFalseFatigue = (c === 'fatigue - criteria not met');

  return { isFov, isValidFatigue, isFalseFatigue };
}
function precisionExFov(valid, total, fov){
  const denom = (Number(total)||0) - (Number(fov)||0);
  if(denom <= 0) return 0;
  return (Number(valid)||0) / denom * 100;
}
function isVerifiedFatigue(e){
  const c = (e.classification || '').toLowerCase().trim();
  const conf = (e.confirmation || '').toLowerCase().trim();
  return (conf === 'verified') && (c === 'fatigue - microsleep' || c === 'fatigue - drowsiness');
}
function isFovMisaligned(e){
  const c = (e.classification || '').toLowerCase().trim();
  const t = (e.event_type || '').toLowerCase().trim();

  const hasMisaligned = c.includes('camera misaligned') || t.includes('camera misaligned');

  const isFov =
    t.includes('field of view') || t.includes('fov') ||
    c.includes('field of view') || c.startsWith('fov exception');

  return isFov && hasMisaligned;
}

/* =======================================================================================
   SECTION: Weeks + Classification panels
======================================================================================= */
function refreshWeeksPanel(){
  const panel = document.getElementById('week-panel');
  if(!rawEvents.length){
    panel.innerHTML = `<div style="color:#7f8c8d;font-size:12px;">No weeks loaded yet</div>`;
    selectedWeeks = new Set();
    weeksManuallyChanged = false;
    return;
  }
  const counts = new Map();
  for(const e of rawEvents){
    counts.set(e.fileWeek, (counts.get(e.fileWeek) || 0) + 1);
  }
  const weeks = Array.from(counts.keys()).sort();

  if(selectedWeeks.size === 0 && !weeksManuallyChanged){
    selectedWeeks = new Set(weeks);
  } else {
    selectedWeeks = new Set(Array.from(selectedWeeks).filter(w => counts.has(w)));
  }

  panel.innerHTML = weeks.map(w => {
    const checked = selectedWeeks.has(w) ? 'checked' : '';
    const count = counts.get(w);
    return `
      <div class="item">
        <div class="left">
          <input type="checkbox" class="wk" data-week="${esc(w)}" ${checked}/>
          <div><strong>${esc(w)}</strong></div>
        </div>
        <div class="count">${count.toLocaleString()} events</div>
      </div>
    `;
  }).join('');

  panel.querySelectorAll('.wk').forEach(cb => {
    cb.addEventListener('change', () => {
      weeksManuallyChanged = true;
      const wk = cb.getAttribute('data-week');
      if(cb.checked) selectedWeeks.add(wk);
      else selectedWeeks.delete(wk);

      refreshClassificationPanel();
      applyAutoDateRange();
      renderAll();
      schedulePersist();
    });
  });
}
function getAvailableClassifications(){
  const base = selectedWeeks.size ? rawEvents.filter(e => selectedWeeks.has(e.fileWeek)) : rawEvents;
  const set = new Set(base.map(e => (e.classification || '').trim()).filter(Boolean));
  return Array.from(set).sort((a,b) => a.localeCompare(b));
}
function refreshClassificationPanel(){
  const panel = document.getElementById('class-panel');
  const search = (document.getElementById('class-search')?.value || '').toLowerCase();

  if(!rawEvents.length){
    panel.innerHTML = `<div style="color:#7f8c8d;font-size:12px;">Upload CSV(s) to load classifications</div>`;
    selectedClasses = new Set();
    classesManuallyChanged = false;
    return;
  }

  const classes = getAvailableClassifications();
  if(selectedClasses.size === 0 && !classesManuallyChanged){
    selectedClasses = new Set(classes);
  } else {
    selectedClasses = new Set(Array.from(selectedClasses).filter(c => classes.includes(c)));
  }

  const shown = search ? classes.filter(c => c.toLowerCase().includes(search)) : classes;

  panel.innerHTML = shown.map(c => {
    const checked = selectedClasses.has(c) ? 'checked' : '';
    return `
      <div class="item">
        <div class="left">
          <input type="checkbox" class="cl" data-class="${esc(c)}" ${checked}/>
          <div>${esc(c)}</div>
        </div>
        <div class="count">&nbsp;</div>
      </div>
    `;
  }).join('') || `<div style="color:#7f8c8d;font-size:12px;">No classifications match your search</div>`;

  panel.querySelectorAll('.cl').forEach(cb => {
    cb.addEventListener('change', () => {
      classesManuallyChanged = true;
      const c = cb.getAttribute('data-class');
      if(cb.checked) selectedClasses.add(c);
      else selectedClasses.delete(c);
      renderAll(); // Option B: only Fleet table/drilldowns are impacted; KPIs stay Network-only
      schedulePersist();
    });
  });
}
function applyClassificationFilter_FleetTabOnly(events){
  if(selectedClasses.size === 0) return [];
  return events.filter(e => selectedClasses.has((e.classification || '').trim()));
}

/* =======================================================================================
   SECTION: Email filter panel (Interventions)
======================================================================================= */
function getAllEmailBuckets(){
  return ['red','yellow','grey','na'];
}
function bucketLabel(b){
  if(b === 'red') return 'Red (> 20)';
  if(b === 'yellow') return 'Yellow (10‚Äì20)';
  if(b === 'grey') return 'Grey (< 10)';
  return 'N/A';
}
function refreshEmailsPanel(){
  const panel = document.getElementById('emails-panel');
  if(!rawEvents.length){
    panel.innerHTML = `<div style="color:#7f8c8d;font-size:12px;">Upload CSV(s) to enable email filtering</div>`;
    selectedEmailBuckets = new Set();
    emailsManuallyChanged = false;
    return;
  }

  const buckets = getAllEmailBuckets();
  if(selectedEmailBuckets.size === 0 && !emailsManuallyChanged){
    selectedEmailBuckets = new Set(buckets);
  } else {
    selectedEmailBuckets = new Set(Array.from(selectedEmailBuckets).filter(b => buckets.includes(b)));
  }

  panel.innerHTML = buckets.map(b => {
    const checked = selectedEmailBuckets.has(b) ? 'checked' : '';
    const chip =
      b === 'red' ? `<span class="email-chip email-high">${esc(bucketLabel(b))}</span>` :
      b === 'yellow' ? `<span class="email-chip email-med">${esc(bucketLabel(b))}</span>` :
      b === 'grey' ? `<span class="email-chip email-low">${esc(bucketLabel(b))}</span>` :
      `<span class="email-chip email-na">${esc(bucketLabel(b))}</span>`;
    return `
      <label style="display:flex; align-items:center; gap:8px; margin:0; font-weight:normal;">
        <input type="checkbox" class="eb" data-eb="${esc(b)}" ${checked}/>
        ${chip}
      </label>
    `;
  }).join('');

  panel.querySelectorAll('.eb').forEach(cb => {
    cb.addEventListener('change', () => {
      emailsManuallyChanged = true;
      const b = cb.getAttribute('data-eb');
      if(cb.checked) selectedEmailBuckets.add(b);
      else selectedEmailBuckets.delete(b);
      renderAll();
      schedulePersist();
    });
  });
}

/* =======================================================================================
   SECTION: Date display + Auto range
======================================================================================= */
function updateDateDisplay(){
  const ds = document.getElementById('ds').value;
  const de = document.getElementById('de').value;
  const el = document.getElementById('date-display');

  if(ds && de){
    const a = new Date(ds + "T00:00:00");
    const b = new Date(de + "T00:00:00");
    const opt = { year:'numeric', month:'short', day:'numeric' };
    el.textContent = (ds === de) ? a.toLocaleDateString('en-US', opt) : `${a.toLocaleDateString('en-US', opt)} - ${b.toLocaleDateString('en-US', opt)}`;
  } else {
    el.textContent = rawEvents.length ? 'Select weeks' : 'Upload CSV(s)';
  }
}
function applyAutoDateRange(){
  if(!rawEvents.length) return;
  if(selectedWeeks.size === 0) return;
  const inWeeks = rawEvents.filter(e => selectedWeeks.has(e.fileWeek));
  if(!inWeeks.length) return;
  const dates = inWeeks.map(e => e.dateISO).filter(Boolean).sort();
  if(!dates.length) return;
  document.getElementById('ds').value = dates[0];
  document.getElementById('de').value = dates[dates.length - 1];
  updateDateDisplay();
}

/* =======================================================================================
   SECTION: Network filters (classification is NOT part of this)
======================================================================================= */
function refreshFleetDropdown(){
  const input = document.getElementById('fleet');
  const datalist = document.getElementById('fleet-list');
  const fleets = Array.from(new Set(rawEvents.map(e => e.fleet))).filter(Boolean).sort();
  
  // Clear and rebuild datalist
  datalist.innerHTML = '<option value="">(all)</option>';
  fleets.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f;
    datalist.appendChild(opt);
  });
}
function normalizeFleetInput(val){
  return String(val||'').trim();
}

function refreshVehicleDropdown(){
  const sel = document.getElementById('vehicle');
  // Get vehicles from filtered fleet data
  let events = rawEvents;
  if(selectedWeeks.size > 0) {
    events = events.filter(e => selectedWeeks.has(e.fileWeek));
  }
  
  // Get selected fleet from input
  const fleetInput = document.getElementById('fleet');
  const selectedFleet = normalizeFleetInput(fleetInput.value);
  
  if(selectedFleet && selectedFleet !== '(all)') {
    events = events.filter(e => e.fleet === selectedFleet);
  }
  
  const vehicles = Array.from(new Set(events.map(e => e.vehicle))).filter(Boolean).sort();
  
  // Keep the first "(all)" option and add vehicle options
  const allOption = sel.querySelector('option[value=""]');
  sel.innerHTML = '';
  if (allOption) sel.appendChild(allOption);
  else sel.innerHTML = '<option value="">(all)</option>';
  
  vehicles.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

function filterEventsNetworkOnly(){
  let data = rawEvents;
  if(rawEvents.length){
    // Use selectedWeeks directly (managed by week panel checkboxes)
    if(selectedWeeks.size === 0) return [];
    data = data.filter(e => selectedWeeks.has(e.fileWeek));
  }

  const ds = document.getElementById('ds').value;
  const de = document.getElementById('de').value;
  if(ds && de) data = data.filter(e => e.dateISO >= ds && e.dateISO <= de);

  // Handle single fleet input with datalist
  const fleetInput = document.getElementById('fleet');
  const selectedFleet = normalizeFleetInput(fleetInput.value);
  if(selectedFleet && selectedFleet !== '(all)') {
    data = data.filter(e => e.fleet === selectedFleet);
  }

  // Handle vehicle dropdown
  const vehicle = document.getElementById('vehicle').value;
  if(vehicle) data = data.filter(e => e.vehicle === vehicle);

  return data;
}

/* =======================================================================================
   SECTION: Fleet aggregation + software version mix
======================================================================================= */
function computeLatestVersion(events){
  const versions = new Set();
  for(const e of events){
    const s = String(e.software_version ?? '').trim();
    if(s) versions.add(s);
  }
  const arr = Array.from(versions);
  if(!arr.length) return null;
  arr.sort((a,b) => cmpVersion(a,b));
  return arr[arr.length - 1];
}
function vehicleVersionFromEvents(events){
  const freq = new Map();
  let lastNonEmpty = null;
  for(const e of events){
    const s = String(e.software_version ?? '').trim();
    if(!s) continue;
    lastNonEmpty = s;
    freq.set(s, (freq.get(s) || 0) + 1);
  }
  if(freq.size === 0) return '';
  let best = lastNonEmpty;
  let bestN = -1;
  for(const [k,v] of freq.entries()){
    if(v > bestN){ bestN = v; best = k; }
  }
  return best;
}
function aggregateFleetVehicle(events){
  const fleetMap = new Map();
  const vehMap = new Map();

  const vehEventsMap = new Map();
  for(const e of events){
    const key = `${e.fleet}|${e.vehicle}`;
    if(!vehEventsMap.has(key)) vehEventsMap.set(key, []);
    vehEventsMap.get(key).push(e);
  }

  latestVersionStr = computeLatestVersion(events);

  const vehVersionMap = new Map();
  for(const [key, arr] of vehEventsMap.entries()){
    arr.sort((a,b) => a.dt_ms - b.dt_ms);
    vehVersionMap.set(key, vehicleVersionFromEvents(arr));
  }

  for(const e of events){
    const { isFov, isValidFatigue, isFalseFatigue } = classifyEvent(e);

    if(!fleetMap.has(e.fleet)){
      fleetMap.set(e.fleet, {
        fleet:e.fleet,
        total_events:0, valid_fatigue:0, false_events:0, fov_events:0,
        ids_total:new Set(), ids_valid:new Set(), ids_false:new Set(), ids_fov:new Set(),
        precision:0, version_mix:''
      });
    }
    const f = fleetMap.get(e.fleet);
    f.total_events++; f.ids_total.add(e.event_id);
    if(isValidFatigue){ f.valid_fatigue++; f.ids_valid.add(e.event_id); }
    if(isFalseFatigue){ f.false_events++; f.ids_false.add(e.event_id); }
    if(isFov){ f.fov_events++; f.ids_fov.add(e.event_id); }

    const key = `${e.fleet}|${e.vehicle}`;
    if(!vehMap.has(key)){
      vehMap.set(key, {
        fleet:e.fleet, vehicle:e.vehicle,
        total_events:0, valid_fatigue:0, false_events:0, fov_events:0,
        ids_total:new Set(), ids_valid:new Set(), ids_false:new Set(), ids_fov:new Set(),
        precision:0,
        software_version: vehVersionMap.get(key) || ''
      });
    }
    const v = vehMap.get(key);
    v.total_events++; v.ids_total.add(e.event_id);
    if(isValidFatigue){ v.valid_fatigue++; v.ids_valid.add(e.event_id); }
    if(isFalseFatigue){ v.false_events++; v.ids_false.add(e.event_id); }
    if(isFov){ v.fov_events++; v.ids_fov.add(e.event_id); }
  }

  const fleets = Array.from(fleetMap.values()).map(x => ({ ...x, precision: precisionExFov(x.valid_fatigue, x.total_events, x.fov_events) }));
  const vehicles = Array.from(vehMap.values()).map(x => ({ ...x, precision: precisionExFov(x.valid_fatigue, x.total_events, x.fov_events) }));
window.__DASH_DATA__ = { vehicles, fleets };

  const vehiclesByFleet = new Map();
  for(const v of vehicles){
    if(!vehiclesByFleet.has(v.fleet)) vehiclesByFleet.set(v.fleet, []);
    vehiclesByFleet.get(v.fleet).push(v);
  }
  for(const f of fleets){
    const arr = vehiclesByFleet.get(f.fleet) || [];
    let withVer=0, up=0;
    for(const v of arr){
      const sv = String(v.software_version || '').trim();
      if(!sv) continue;
      withVer++;
      if(latestVersionStr && cmpVersion(sv, latestVersionStr) === 0) up++;
    }
    const pct = (withVer > 0) ? Math.round((up/withVer)*100) : 0;
    f.version_mix = latestVersionStr ? `${pct}% on ${latestVersionStr}` : `${pct}% updated`;
  }

  fleetAggByName = new Map(fleets.map(f => [f.fleet, f]));
  vehicleAggByKey = new Map(vehicles.map(v => [`${v.fleet}|${v.vehicle}`, v]));
  return { fleets, vehicles };
}

/* =======================================================================================
   SECTION: Fleet rendering + drilldown click
======================================================================================= */
function sortFleets(fleets){
  const out = [...fleets];
  if(!sortState.col){
    out.sort((a,b) => a.fleet.localeCompare(b.fleet));
    return out;
  }
  out.sort((a,b) => {
    const col = sortState.col;
    const dir = sortState.dir;

    const isStr = (col === 'fleet' || col === 'version_mix');
    if(isStr){
      return (dir === 'asc')
        ? String(a[col]||'').localeCompare(String(b[col]||''))
        : String(b[col]||'').localeCompare(String(a[col]||''));
    }
    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return a.fleet.localeCompare(b.fleet);
    return (dir === 'asc') ? (av - bv) : (bv - av);
  });
  return out;
}
function sortVehiclesForFleet(vehicles){
  const col = sortState.col;
  const dir = sortState.dir;

  const out = [...vehicles];
  if(!col || col === 'fleet' || col === 'version_mix'){
    out.sort((a,b)=> a.vehicle.localeCompare(b.vehicle));
    return out;
  }
  out.sort((a,b)=>{
    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return a.vehicle.localeCompare(b.vehicle);
    return (dir === 'asc') ? (av - bv) : (bv - av);
  });
  return out;
}
function toggleFleet(name){
  if(expandedFleets.has(name)) expandedFleets.delete(name);
  else expandedFleets.add(name);

  const frow = document.querySelector(`.fleet-row[data-fleet="${CSS.escape(name)}"]`);
  if(frow){
    const icon = frow.querySelector('.expand');
    if(icon) icon.classList.toggle('on');
  }
  document.querySelectorAll(`.asset-row[data-fleet="${CSS.escape(name)}"]`).forEach(r => r.classList.toggle('visible'));
  schedulePersist();
}

/* ===== Option B: KPIs ALWAYS computed from Network-only events; Total Events KPI uses toggle ===== */
function renderTopStatsFromNetworkEvents(networkEvents, fleetsNetAgg, vehiclesNetAgg){
  const includeFov = !!document.getElementById('kpi-include-fov')?.checked;

  // counts from NETWORK EVENTS (not classification-filtered)
  let totalAll = networkEvents.length;
  let fovCount = 0;
  let validCount = 0;

  for(const e of networkEvents){
    const { isFov, isValidFatigue } = classifyEvent(e);
    if(isFov) fovCount++;
    if(isValidFatigue) validCount++;
  }

  const totalNonFov = Math.max(0, totalAll - fovCount);
  const totalForKpi = includeFov ? totalAll : totalNonFov;

  const prec = precisionExFov(validCount, totalAll, fovCount);
  const pClass = precisionClass(prec);

  // unique vehicles + version updated % from NETWORK aggregation
  const vehUnique = new Map();
  for(const v of vehiclesNetAgg){
    vehUnique.set(`${v.fleet}|${v.vehicle}`, String(v.software_version||'').trim());
  }
  let withVer=0, up=0;
  for(const sv of vehUnique.values()){
    if(!sv) continue;
    withVer++;
    if(latestVersionStr && cmpVersion(sv, latestVersionStr) === 0) up++;
  }
  const pctUp = (withVer > 0) ? Math.round((up/withVer)*100) : 0;

  document.getElementById('s-fleets').textContent = String(fleetsNetAgg.length);
  document.getElementById('s-veh').textContent = String(new Set(vehiclesNetAgg.map(v => `${v.fleet}|${v.vehicle}`)).size);
  document.getElementById('s-total').textContent = totalForKpi.toLocaleString();
  document.getElementById('s-valid').textContent = validCount.toLocaleString();
  document.getElementById('s-fov').textContent = fovCount.toLocaleString();
  document.getElementById('s-prec').innerHTML = `<span class="prec-cell ${pClass}" style="font-size:22px; min-width:0;">${prec.toFixed(1)}%</span>`;
  document.getElementById('s-updated').textContent = `${pctUp}%`;
}

function openEvidenceModal(title, subtitle, rows, downloadName){
  modalRowsCache = rows || [];
  modalDownloadName = downloadName || 'evidence.csv';

  document.getElementById('modal-title').textContent = title || 'Evidence';
  document.getElementById('modal-sub').textContent = subtitle || '';

  const tbody = document.getElementById('modal-body-rows');

  if(!modalRowsCache.length){
    tbody.innerHTML = `<tr><td colspan="12" style="padding:16px; color:#7f8c8d;">No matching events found.</td></tr>`;
    document.getElementById('modal-foot').textContent = '';
  } else {
    const sorted = [...modalRowsCache].sort((a,b)=> (b.dt_ms||0) - (a.dt_ms||0));
    tbody.innerHTML = sorted.map(e => `
      <tr>
        <td>${esc(e.fileWeek||'')}</td>
        <td>${esc(e.dateISO||'')}</td>
        <td>${esc(e.dt_raw||fmtDateTime(e.dt_ms))}</td>
        <td>${esc(e.event_id||'')}</td>
        <td>${esc(e.fleet||'')}</td>
        <td>${esc(e.vehicle||'')}</td>
        <td>${esc(e.classification||'')}</td>
        <td>${esc(e.event_type||'')}</td>
        <td>${esc(e.confirmation||'')}</td>
        <td>${(e.latitude==null?'':esc(e.latitude))}</td>
        <td>${(e.longitude==null?'':esc(e.longitude))}</td>
        <td>${esc(e.software_version||'')}</td>
      </tr>
    `).join('');
    document.getElementById('modal-foot').textContent = `Rows: ${sorted.length.toLocaleString()} (sorted newest ‚Üí oldest).`;
  }

  document.getElementById('modal-backdrop').style.display = 'flex';
}
function closeEvidenceModal(){ document.getElementById('modal-backdrop').style.display = 'none'; }
document.getElementById('modal-close').addEventListener('click', closeEvidenceModal);
document.getElementById('modal-backdrop').addEventListener('click', (e) => { if(e.target.id === 'modal-backdrop') closeEvidenceModal(); });
document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeEvidenceModal(); });

document.getElementById('modal-download').addEventListener('click', () => {
  const rows = modalRowsCache || [];
  const headers = ['week','date','detection_time','event_id','fleet','vehicle','classification','event_type','confirmation','latitude','longitude','software_version'];
  const lines = [headers.join(',')];

  for(const e of rows){
    const vals = [
      e.fileWeek||'',
      e.dateISO||'',
      e.dt_raw||fmtDateTime(e.dt_ms)||'',
      e.event_id||'',
      e.fleet||'',
      e.vehicle||'',
      e.classification||'',
      e.event_type||'',
      e.confirmation||'',
      (e.latitude==null?'':String(e.latitude)),
      (e.longitude==null?'':String(e.longitude)),
      e.software_version||''
    ].map(v => `"${String(v).replace(/"/g,'""')}"`);
    lines.push(vals.join(','));
  }

  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = modalDownloadName || 'evidence.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
});

function eventsByIdSet(idsSet, eventsUniverse){
  const ids = new Set(idsSet || []);
  if(ids.size === 0) return [];
  return (eventsUniverse || []).filter(e => ids.has(e.event_id));
}

function renderFleetTable(fleets, vehicles){
  const tbody = document.getElementById('tbody');
  const nodata = document.getElementById('nodata');
  tbody.innerHTML = '';

  if(!rawEvents.length){
    nodata.style.display = 'block';
    nodata.textContent = 'Upload weekly CSV(s) to view data';
    return;
  }
  if(!fleets.length){
    nodata.style.display = 'block';
    nodata.textContent = 'No data matches your current filters';
    return;
  }
  nodata.style.display = 'none';

  // Get selected zones from checkboxes
  const selectedZones = Array.from(document.querySelectorAll('.zone-checkbox:checked'))
    .map(cb => cb.dataset.zone);
  
  let fleetsFiltered = fleets;
  if(!selectedZones.includes('all')){
    fleetsFiltered = fleets.filter(f => selectedZones.includes(precisionBucket(f.precision)));
  }

  const fleetsSorted = sortFleets(fleetsFiltered);

  for(const f of fleetsSorted){
    const fleetVehiclesRaw = vehicles.filter(v => v.fleet === f.fleet);
    const fleetVehicles = sortVehiclesForFleet(fleetVehiclesRaw);

    const pClass = precisionClass(f.precision);
    const tr = document.createElement('tr');
    tr.className = 'fleet-row';
    tr.dataset.fleet = f.fleet;

    const link = (metric) => {
      const val = f[metric] || 0;
      if(val <= 0) return `<span class="num">${val.toLocaleString()}</span>`;
      return `<span class="link num" data-drill="fleet" data-fleet="${esc(f.fleet)}" data-metric="${esc(metric)}">${val.toLocaleString()}</span>`;
    };

    tr.innerHTML = `
      <td>
        <span class="expand ${expandedFleets.has(f.fleet) ? 'on':''}">‚ñ∂</span>
        <strong>${esc(f.fleet)}</strong>
        <span class="badge badge-info">${fleetVehicles.length} vehicles</span>
      </td>
      <td class="num">${link('total_events')}</td>
      <td class="num">${link('valid_fatigue')}</td>
      <td class="num">${link('false_events')}</td>
      <td class="num">${link('fov_events')}</td>
      <td class="num"><span class="prec-cell ${pClass}">${f.precision.toFixed(1)}%</span></td>
      <td>${esc(f.version_mix || '')}</td>
    `;

    tr.addEventListener('click', (e) => {
      if(e.target && e.target.classList && e.target.classList.contains('link')) return;
      toggleFleet(f.fleet);
    });

    tbody.appendChild(tr);

    for(const v of fleetVehicles){
      const vpClass = precisionClass(v.precision);
      const isLatest = latestVersionStr && String(v.software_version||'').trim() && (cmpVersion(v.software_version, latestVersionStr) === 0);

      const vlink = (metric) => {
        const val = v[metric] || 0;
        if(val <= 0) return `<span class="num">${val.toLocaleString()}</span>`;
        return `<span class="link num" data-drill="vehicle" data-fleet="${esc(v.fleet)}" data-vehicle="${esc(v.vehicle)}" data-metric="${esc(metric)}">${val.toLocaleString()}</span>`;
      };

      const r = document.createElement('tr');
      r.className = 'asset-row';
      r.dataset.fleet = f.fleet;
      if(expandedFleets.has(f.fleet)) r.classList.add('visible');

      r.innerHTML = `
        <td>${esc(v.vehicle)} &nbsp; ${versionBadgeHTML(v.software_version, isLatest)}</td>
        <td class="num">${vlink('total_events')}</td>
        <td class="num">${vlink('valid_fatigue')}</td>
        <td class="num">${vlink('false_events')}</td>
        <td class="num">${vlink('fov_events')}</td>
        <td class="num"><span class="prec-cell ${vpClass}">${v.precision.toFixed(1)}%</span></td>
        <td>${esc(v.software_version || '')}</td>
      `;
      tbody.appendChild(r);
    }
  }
}

/* Fleet drilldown */
document.addEventListener('click', (e) => {
  const el = e.target.closest('.link[data-drill]');
  if(!el) return;

  const drill = el.getAttribute('data-drill');
  const metric = el.getAttribute('data-metric');
  const fleet = el.getAttribute('data-fleet');
  const vehicle = el.getAttribute('data-vehicle') || '';

  let idsSet = null;
  let title = '';

  if(drill === 'fleet'){
    const agg = fleetAggByName.get(fleet);
    if(!agg) return;
    if(metric === 'total_events') idsSet = agg.ids_total;
    if(metric === 'valid_fatigue') idsSet = agg.ids_valid;
    if(metric === 'false_events') idsSet = agg.ids_false;
    if(metric === 'fov_events') idsSet = agg.ids_fov;
    title = `Fleet Evidence ‚Äî ${fleet} ‚Äî ${metric.replace('_',' ')}`;
  } else {
    const agg = vehicleAggByKey.get(`${fleet}|${vehicle}`);
    if(!agg) return;
    if(metric === 'total_events') idsSet = agg.ids_total;
    if(metric === 'valid_fatigue') idsSet = agg.ids_valid;
    if(metric === 'false_events') idsSet = agg.ids_false;
    if(metric === 'fov_events') idsSet = agg.ids_fov;
    title = `Vehicle Evidence ‚Äî ${fleet} / ${vehicle} ‚Äî ${metric.replace('_',' ')}`;
  }

  // Option B: Fleet drilldowns respect the Fleet table view filter (Network + Classification)
  const rows = eventsByIdSet(idsSet, currentFilteredEvents);
  const sub = `Network filters applied (weeks/date/fleet/vehicle/classification).`;
  const dl = `${fleet}_${vehicle || 'fleet'}_${metric}_evidence.csv`.replace(/\s+/g,'_');
  openEvidenceModal(title, sub, rows, dl);
});

/* =======================================================================================
   SECTION: Interventions tab (CAP KPI per vehicle/day/shift)
======================================================================================= */
function getInterventionCap(){
  const raw = (document.getElementById('int-cap-text')?.value || '').trim();
  const n = parseInt(raw, 10);
  if(!Number.isFinite(n) || n <= 0) return 10;
  return Math.min(99, n);
}
function shiftKeyForEvent(e){
  const shift = shiftLabel(e.dt_ms);
  return { dateISO: e.dateISO, shift };
}

function buildInterventionsRows(eventsGlobal){
  const cap = getInterventionCap();

  const grpAll = new Map();
  for(const e of eventsGlobal){
    if(!Number.isFinite(e.dt_ms)) continue;
    const s = shiftKeyForEvent(e);
    const key = `${s.dateISO}|${s.shift}|${e.fleet}|${e.vehicle}`;
    if(!grpAll.has(key)) grpAll.set(key, []);
    grpAll.get(key).push(e);
  }

  const grpVF = new Map();
  for(const e of eventsGlobal){
    if(!Number.isFinite(e.dt_ms)) continue;
    if(!isVerifiedFatigue(e)) continue;
    const s = shiftKeyForEvent(e);
    const key = `${s.dateISO}|${s.shift}|${e.fleet}|${e.vehicle}`;
    if(!grpVF.has(key)) grpVF.set(key, []);
    grpVF.get(key).push(e);
  }

  const rows = [];
  for(const [key, allArr] of grpAll.entries()){
    const [dateISO, shift, fleet, vehicle] = key.split('|');
    const vfArr = (grpVF.get(key) || []).slice().sort((a,b)=>a.dt_ms - b.dt_ms);

    const verified_total = vfArr.length;
    if(verified_total <= 0) continue;

    const calls = Math.min(cap, verified_total);
    const emails = Math.max(0, verified_total - cap);

    const capEvent = (verified_total >= cap) ? vfArr[cap-1] : null;
    const lastEmail = (emails > 0) ? vfArr[vfArr.length - 1] : null;

    const capLat = capEvent?.latitude ?? null;
    const capLon = capEvent?.longitude ?? null;
    const emailLat = lastEmail?.latitude ?? null;
    const emailLon = lastEmail?.longitude ?? null;
    const miles = (emails > 0) ? haversineMiles(capLat, capLon, emailLat, emailLon) : null;

    const sv = vehicleVersionFromEvents(allArr.slice().sort((a,b)=>a.dt_ms - b.dt_ms));

    rows.push({
      key,
      dateISO, shift, fleet, vehicle,
      total_events: allArr.length,
      verified_total,
      calls,
      emails,
      cap_time_ms: capEvent ? capEvent.dt_ms : null,
      cap_time: capEvent ? fmtDateTime(capEvent.dt_ms) : 'N/A',
      last_email_time_ms: lastEmail ? lastEmail.dt_ms : null,
      last_email_time: lastEmail ? fmtDateTime(lastEmail.dt_ms) : 'N/A',
      cap_lat: Number.isFinite(capLat) ? capLat : null,
      cap_lon: Number.isFinite(capLon) ? capLon : null,
      email_lat: Number.isFinite(emailLat) ? emailLat : null,
      email_lon: Number.isFinite(emailLon) ? emailLon : null,
      cap_to_email_miles: Number.isFinite(miles) ? miles : null,
      software_version: sv || '',
      emailEvents: (emails > 0) ? vfArr.slice(cap) : []
    });
  }
  return rows;
}

function sortInterventionsRows(rows){
  const col = intSort.col;
  const dir = intSort.dir;
  const mul = (dir === 'asc') ? 1 : -1;
  const str = (x) => String(x ?? '').toLowerCase();
  const out = [...rows];

  out.sort((a,b) => {
    if(col === 'dateISO' || col === 'shift' || col === 'fleet' || col === 'vehicle' || col === 'software_version'){
      const av = str(a[col]);
      const bv = str(b[col]);
      if(av === bv) return str(a.vehicle).localeCompare(str(b.vehicle)) * mul;
      return av.localeCompare(bv) * mul;
    }

    if(col === 'cap_time' || col === 'last_email_time'){
      const av = Number.isFinite(a[col + '_ms']) ? a[col + '_ms'] : -Infinity;
      const bv = Number.isFinite(b[col + '_ms']) ? b[col + '_ms'] : -Infinity;
      if(av === bv) return str(a.vehicle).localeCompare(str(b.vehicle)) * mul;
      return (av - bv) * mul;
    }

    const av = Number(a[col] ?? -Infinity);
    const bv = Number(b[col] ?? -Infinity);
    if(av === bv) return str(a.vehicle).localeCompare(str(b.vehicle)) * mul;
    return (av - bv) * mul;
  });

  return out;
}

function pct(n, d){
  if(!Number.isFinite(n) || !Number.isFinite(d) || d <= 0) return 0;
  return Math.round((n/d)*100);
}

function applyEmailBucketFilter(rows){
  if(selectedEmailBuckets.size === 0) return [];
  return rows.filter(r => selectedEmailBuckets.has(emailBucketFromCount(r.emails)));
}

function renderInterventionsTab(eventsGlobal){
  const tbody = document.getElementById('int-body');
  const nodata = document.getElementById('int-nodata');
  const kpis = document.getElementById('int-kpis');

  tbody.innerHTML = '';
  kpis.innerHTML = '';

  if(!rawEvents.length){
    nodata.style.display = 'block';
    nodata.textContent = 'Upload CSV(s) to view interventions';
    return;
  }

  const cap = getInterventionCap();
  const allRowsRaw = buildInterventionsRows(eventsGlobal);

  // Apply Email Bucket filter (affects KPIs + table)
  let allRows = applyEmailBucketFilter(allRowsRaw);

  // Apply Zone filter based on fleet precision
  const selectedZones = Array.from(document.querySelectorAll('.int-zone-checkbox:checked'))
    .map(cb => cb.dataset.zone);
  
  if(!selectedZones.includes('all') && window.__DASH_DATA__?.fleets){
    // Build fleet precision map
    const fleetPrecisionMap = new Map();
    window.__DASH_DATA__.fleets.forEach(f => {
      fleetPrecisionMap.set(f.fleet, f.precision);
    });
    
    // Filter rows by fleet zone
    allRows = allRows.filter(r => {
      const fleetPrec = fleetPrecisionMap.get(r.fleet);
      if(fleetPrec == null) return true; // Include if precision unknown
      const zone = precisionBucket(fleetPrec);
      return selectedZones.includes(zone);
    });
  }

  if(!allRows.length){
    nodata.style.display = 'block';
    nodata.textContent = 'No interventions rows match your current filters (including Email filter)';
    return;
  }
  nodata.style.display = 'none';

  const totalVerified = allRows.reduce((s,r)=> s + (r.verified_total||0), 0);
  const dayVerified = allRows.filter(r => r.shift === 'Day').reduce((s,r)=> s + (r.verified_total||0), 0);
  const nightVerified = allRows.filter(r => r.shift === 'Night').reduce((s,r)=> s + (r.verified_total||0), 0);

  const verifiedInCapShifts = allRows.filter(r => r.verified_total >= cap).reduce((s,r)=> s + (r.verified_total||0), 0);
  const verifiedInDayCap = allRows.filter(r => r.shift === 'Day' && r.verified_total >= cap).reduce((s,r)=> s + (r.verified_total||0), 0);
  const verifiedInNightCap = allRows.filter(r => r.shift === 'Night' && r.verified_total >= cap).reduce((s,r)=> s + (r.verified_total||0), 0);

  kpis.innerHTML = [
    {k:`Total Verified Valid Fatigue`, v: `${totalVerified.toLocaleString()}`},
    {k:`Day Verified (count / % of verified)`, v: `${dayVerified.toLocaleString()} (${pct(dayVerified,totalVerified)}%)`},
    {k:`Night Verified (count / % of verified)`, v: `${nightVerified.toLocaleString()} (${pct(nightVerified,totalVerified)}%)`},
    {k:`Vehicle-shifts ‚â• CAP (${cap}) (verified / % of verified)`, v: `${verifiedInCapShifts.toLocaleString()} (${pct(verifiedInCapShifts,totalVerified)}%)`},
    {k:`Day shifts ‚â• CAP (verified / % of verified)`, v: `${verifiedInDayCap.toLocaleString()} (${pct(verifiedInDayCap,totalVerified)}%)`},
    {k:`Night shifts ‚â• CAP (verified / % of verified)`, v: `${verifiedInNightCap.toLocaleString()} (${pct(verifiedInNightCap,totalVerified)}%)`}
  ].map(x => `<div class="kpi"><div class="v">${esc(x.v)}</div><div class="k">${esc(x.k)}</div></div>`).join('');

  const rows = sortInterventionsRows(allRows);
  intRowByKey = new Map(rows.map(r => [r.key, r]));

  tbody.innerHTML = rows.map(r => {
    const isLatest = latestVersionStr && r.software_version && (cmpVersion(r.software_version, latestVersionStr) === 0);

    const emailsClickable = (r.emails||0) > 0;
    const emailsCell = emailChipHTML(
      (r.emails == null ? null : r.emails),
      emailsClickable,
      r.key
    );

    const fmtNum = (x, d=5) => Number.isFinite(x) ? Number(x).toFixed(d) : '';
    const fmtMiles = (x) => Number.isFinite(x) ? Number(x).toFixed(2) : '';

    return `
      <tr>
        <td>${esc(r.dateISO)}</td>
        <td>${esc(r.shift)}</td>
        <td>${esc(r.fleet)}</td>
        <td>${esc(r.vehicle)}</td>
        <td class="num">${(r.total_events||0).toLocaleString()}</td>
        <td class="num">${(r.verified_total||0).toLocaleString()}</td>
        <td class="num">${(r.calls||0).toLocaleString()}</td>
        <td class="num">${emailsCell}</td>
        <td>${esc(r.cap_time)}</td>
        <td>${esc(r.last_email_time)}</td>
        <td class="num">${fmtNum(r.cap_lat)}</td>
        <td class="num">${fmtNum(r.cap_lon)}</td>
        <td class="num">${fmtNum(r.email_lat)}</td>
        <td class="num">${fmtNum(r.email_lon)}</td>
        <td class="num">${fmtMiles(r.cap_to_email_miles)}</td>
        <td>${versionBadgeHTML(r.software_version, isLatest)}</td>
      </tr>
    `;
  }).join('');
}

/* Emails drilldown */
document.addEventListener('click', (e) => {
  const el = e.target.closest('[data-intdrill="emails"]');
  if(!el) return;
  const key = el.getAttribute('data-key');
  if(!key) return;

  const row = intRowByKey.get(key);
  if(!row) return;

  const cap = getInterventionCap();
  const rowsToShow = row.emailEvents || [];

  const title = `Interventions Evidence ‚Äî Emails (post-cap verified fatigue) ‚Äî ${row.fleet} / ${row.vehicle} ‚Äî ${row.dateISO} (${row.shift})`;
  const sub = `Emails are verified fatigue events beyond the first ${cap} for this vehicle-shift. Network filters applied (weeks/date/fleet/vehicle).`;
  const dl = `${row.fleet}_${row.vehicle}_${row.dateISO}_${row.shift}_emails_postcap.csv`.replace(/\s+/g,'_');

  openEvidenceModal(title, sub, rowsToShow, dl);
});

/* =======================================================================================
   SECTION: FOV tab
======================================================================================= */
function buildFovMisalignedRows(eventsGlobal){
  const misEvents = eventsGlobal.filter(e => isFovMisaligned(e) && Number.isFinite(e.dt_ms));

  const group = new Map();
  for(const e of misEvents){
    const key = `${e.fleet}|${e.vehicle}`;
    if(!group.has(key)){
      group.set(key, {
        fleet: e.fleet,
        vehicle: e.vehicle,
        vehicle_id: e.vehicle_id || '',
        events_count: 0,
        first_fov_ms: e.dt_ms,
        latest_fov_ms: e.dt_ms,
        misalignedEvents: []
      });
    }
    const g = group.get(key);
    g.events_count += 1;
    if(e.dt_ms < g.first_fov_ms) g.first_fov_ms = e.dt_ms;
    if(e.dt_ms > g.latest_fov_ms) g.latest_fov_ms = e.dt_ms;
    if(!g.vehicle_id && e.vehicle_id) g.vehicle_id = e.vehicle_id;
    g.misalignedEvents.push(e);
  }

  const vfByKey = new Map();
  for(const e of eventsGlobal){
    if(!Number.isFinite(e.dt_ms)) continue;
    if(!isVerifiedFatigue(e)) continue;
    const key = `${e.fleet}|${e.vehicle}`;
    if(!vfByKey.has(key)) vfByKey.set(key, []);
    vfByKey.get(key).push(e);
  }
  for(const arr of vfByKey.values()) arr.sort((a,b)=>a.dt_ms - b.dt_ms);

  const rows = [];
  fovRowByKey = new Map();

  for(const [key, g] of group.entries()){
    const vfArr = vfByKey.get(key) || [];

    const vfBefore = vfArr.filter(x => x.dt_ms < g.first_fov_ms);
    const verified_before = vfBefore.length;
    const last_prior_vf = vfBefore.length ? vfBefore[vfBefore.length - 1].dt_ms : null;

    const last_verified_event = vfArr.length ? vfArr[vfArr.length - 1] : null;
    const last_verified_ms = last_verified_event ? last_verified_event.dt_ms : null;
    const last_verified_after_latest_fov = (last_verified_ms !== null) && (last_verified_ms > g.latest_fov_ms);

    let gap_seconds = null;
    if(last_prior_vf !== null) gap_seconds = (g.first_fov_ms - last_prior_vf) / 1000;
    const gap_bucket = gapBucketFromSeconds(gap_seconds);

    const exposure_seconds = Number.isFinite(g.latest_fov_ms) && Number.isFinite(g.first_fov_ms)
      ? (g.latest_fov_ms - g.first_fov_ms) / 1000
      : null;
    const exposure_bucket = exposureBucketFromSeconds(exposure_seconds);

    const firstFovEvent = g.misalignedEvents.reduce((best, e) => (!best || e.dt_ms < best.dt_ms) ? e : best, null);
    const latestFovEvent = g.misalignedEvents.reduce((best, e) => (!best || e.dt_ms > best.dt_ms) ? e : best, null);

    const row = {
      vehicle_id: g.vehicle_id || '',
      fleet: g.fleet,
      vehicle: g.vehicle,
      events_count: g.events_count,

      verified_before,
      last_verified_ms,
      last_verified_after_latest_fov,

      gap_seconds,
      gap_bucket,

      exposure_seconds,
      exposure_bucket,

      first_fov_ms: g.first_fov_ms,
      latest_fov_ms: g.latest_fov_ms,

      vfBeforeEvents: vfBefore,
      lastVerifiedEvent: last_verified_event ? [last_verified_event] : [],
      firstFovEvent: firstFovEvent ? [firstFovEvent] : [],
      latestFovEvent: latestFovEvent ? [latestFovEvent] : []
    };

    rows.push(row);
    fovRowByKey.set(key, row);
  }

  // Validate gap_bucket values for all rows
  const validBuckets = new Set(['red', 'yellow', 'green', 'na']);
  const bucketCounts = { red: 0, yellow: 0, green: 0, na: 0, invalid: 0 };
  const invalidRows = [];
  
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const bucket = row.gap_bucket;
    
    if (!validBuckets.has(bucket)) {
      invalidRows.push({
        index: i,
        fleet: row.fleet,
        vehicle: row.vehicle,
        gap_bucket: bucket,
        gap_seconds: row.gap_seconds,
        verified_before: row.verified_before
      });
      bucketCounts.invalid++;
    } else {
      bucketCounts[bucket]++;
    }
  }
  
  // Log validation results
  console.log(`[buildFovMisalignedRows] Gap bucket validation for ${rows.length} rows:`);
  console.log(`  - Red (‚â§1hr): ${bucketCounts.red}`);
  console.log(`  - Yellow (1hr-24hr): ${bucketCounts.yellow}`);
  console.log(`  - Green (>24hr): ${bucketCounts.green}`);
  console.log(`  - NA (no prior verified): ${bucketCounts.na}`);
  console.log(`  - Invalid: ${bucketCounts.invalid}`);
  
  if (invalidRows.length > 0) {
    console.warn(`[buildFovMisalignedRows] Found ${invalidRows.length} rows with invalid gap_bucket values:`);
    invalidRows.forEach(row => {
      console.warn(`  - Row ${row.index}: Fleet="${row.fleet}", Vehicle="${row.vehicle}", ` +
                   `gap_bucket="${row.gap_bucket}", gap_seconds=${row.gap_seconds}, ` +
                   `verified_before=${row.verified_before}`);
    });
  }

  return rows;
}

function sortFovRows(rows){
  const col = fovSort.col;
  const dir = fovSort.dir;
  const out = [...rows];
  const str = (x) => String(x ?? '').toLowerCase();
  const mul = (dir === 'asc') ? 1 : -1;

  out.sort((a,b) => {
    if(col === 'fleet' || col === 'vehicle_id' || col === 'vehicle' || col === 'gap_bucket' || col === 'exposure_bucket'){
      const av = str(a[col]);
      const bv = str(b[col]);
      if(av === bv) return str(a.vehicle).localeCompare(str(b.vehicle)) * mul;
      return av.localeCompare(bv) * mul;
    }

    if(col === 'last_verified_ms' || col === 'first_fov_ms' || col === 'latest_fov_ms'){
      const av = Number.isFinite(a[col]) ? a[col] : -Infinity;
      const bv = Number.isFinite(b[col]) ? b[col] : -Infinity;
      if(av === bv) return str(a.vehicle).localeCompare(str(b.vehicle)) * mul;
      return (av - bv) * mul;
    }

    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return str(a.vehicle).localeCompare(str(b.vehicle)) * mul;
    return (av - bv) * mul;
  });

  return out;
}

function median(arr){
  const a = arr.filter(Number.isFinite).slice().sort((x,y)=>x-y);
  if(!a.length) return null;
  const mid = Math.floor(a.length/2);
  return a.length % 2 ? a[mid] : (a[mid-1]+a[mid])/2;
}

function renderFovTab(eventsGlobal){
  const tbody = document.getElementById('fov-body');
  const nodata = document.getElementById('fov-nodata');
  const kpis = document.getElementById('fov-kpis');

  tbody.innerHTML = '';
  kpis.innerHTML = '';

  if(!rawEvents.length){
    nodata.style.display = 'block';
    nodata.textContent = 'Upload CSV(s) to view FOV camera misaligned rows';
    return;
  }

  const rowsAll = buildFovMisalignedRows(eventsGlobal);
  
  // Debug rowsAll generation
  console.log("[buildFovMisalignedRows] Total rows processed:", rowsAll.length);
  
  // Debugging: Check for rows with missing or invalid gap_bucket
  rowsAll.forEach((row, index) => {
    if (!row.gap_bucket) {
      console.error(`[buildFovMisalignedRows] Missing gap_bucket in row ${index}:`, row);
    }
    if (row.gap_bucket === 'na') {
      console.warn(`[buildFovMisalignedRows] Row assigned to N/A zone. Row data:`, row);
    }
  });

  const totalVehicles = rowsAll.length;
  const totalEvents = rowsAll.reduce((s,r)=>s + (r.events_count||0), 0);

  const nRed = rowsAll.filter(r => r.gap_bucket === 'red').length;
  const nYellow = rowsAll.filter(r => r.gap_bucket === 'yellow').length;
  const nGreen = rowsAll.filter(r => r.gap_bucket === 'green').length;
  const nNA = rowsAll.filter(r => r.gap_bucket === 'na').length;

  const exposureSecs = rowsAll.map(r => r.exposure_seconds).filter(Number.isFinite);
  const medExposure = median(exposureSecs);
  const pctExposureOver24 = exposureSecs.length
    ? Math.round((exposureSecs.filter(x => x > 86400).length / exposureSecs.length) * 100)
    : 0;

  const fixedLikely = rowsAll.filter(r => r.last_verified_after_latest_fov).length;
  
  // Highlight N/A rows before rendering
  if (nNA > 0) {
    console.warn(`Warning: ${nNA} rows are unclassified (N/A). These are currently excluded from red/yellow/green totals.`);
  }

  kpis.innerHTML = [
    {k:'Vehicles w/ Misaligned', v: totalVehicles.toLocaleString()},
    {k:'Misaligned Events', v: totalEvents.toLocaleString()},
    {k:'Proximity Red (‚â§1h)', v: nRed.toLocaleString()},
    {k:'Proximity Yellow (‚â§24h)', v: nYellow.toLocaleString()},
    {k:'Proximity Green (>24h)', v: nGreen.toLocaleString()},
    {k:'Proximity N/A (Excluded)', v: nNA.toLocaleString()}, // Explicitly show N/A zones
    {k:'Median Exposure', v: (medExposure == null ? 'N/A' : formatHMS(medExposure))},
    {k:'% Exposure > 24h', v: `${pctExposureOver24}%`},
    {k:'Likely Fixed (Last verified fatigue after latest FOV)', v: fixedLikely.toLocaleString()}
  ].map(x => `<div class="kpi"><div class="k">${esc(x.k)}</div><div class="v">${esc(x.v)}</div></div>`).join('');

  const gapFilter = document.getElementById('fov-gap-filter')?.value || 'all';
  let rows = rowsAll;
  if(gapFilter !== 'all') rows = rowsAll.filter(r => r.gap_bucket === gapFilter);

  if(!rows.length){
    nodata.style.display = 'block';
    nodata.textContent = 'No FOV rows match your current filters (including Proximity filter)';
    return;
  }
  nodata.style.display = 'none';

  rows = sortFovRows(rows);

  const gapLabel = (sec) => (!Number.isFinite(sec) ? 'N/A' : formatHMS(sec));
  const exposureLabel = (sec) => (!Number.isFinite(sec) ? 'N/A' : formatHMS(sec));

  tbody.innerHTML = rows.map(r => {
    const key = `${r.fleet}|${r.vehicle}`;

    const proximityHTML = gapChipHTML(r.gap_bucket, gapLabel(r.gap_seconds));
    const exposureHTML = gapChipHTML(r.exposure_bucket, exposureLabel(r.exposure_seconds));

    const lastVF = (r.last_verified_ms != null) ? fmtDateTime(r.last_verified_ms) : 'N/A';
    const lastVFCell = (r.last_verified_ms == null)
      ? `N/A`
      : (r.last_verified_after_latest_fov
          ? `<span class="cell-green link" data-fovdrill="lastVerified" data-key="${esc(key)}">${esc(lastVF)}</span>`
          : `<span class="link" data-fovdrill="lastVerified" data-key="${esc(key)}">${esc(lastVF)}</span>`);

    const firstFov = (r.first_fov_ms != null) ? fmtDateTime(r.first_fov_ms) : 'N/A';
    const latestFov = (r.latest_fov_ms != null) ? fmtDateTime(r.latest_fov_ms) : 'N/A';

    const vfBeforeCell = (r.verified_before > 0)
      ? `<span class="link num" data-fovdrill="vfBefore" data-key="${esc(key)}">${(r.verified_before||0).toLocaleString()}</span>`
      : `<span class="num">0</span>`;

    const firstFovCell = (r.first_fov_ms != null)
      ? `<span class="link" data-fovdrill="firstFov" data-key="${esc(key)}">${esc(firstFov)}</span>`
      : `N/A`;

    const latestFovCell = (r.latest_fov_ms != null)
      ? `<span class="link" data-fovdrill="latestFov" data-key="${esc(key)}">${esc(latestFov)}</span>`
      : `N/A`;

    return `
      <tr>
        <td>${esc(r.vehicle_id || '')}</td>
        <td>${esc(r.fleet)}</td>
        <td>${esc(r.vehicle)}</td>
        <td class="num">${(r.events_count||0).toLocaleString()}</td>
        <td class="num">${vfBeforeCell}</td>
        <td>${lastVFCell}</td>
        <td>${proximityHTML}</td>
        <td>${exposureHTML}</td>
        <td>${firstFovCell}</td>
        <td>${latestFovCell}</td>
      </tr>
    `;
  }).join('');
}

/* FOV drilldown */
document.addEventListener('click', (e) => {
  const el = e.target.closest('[data-fovdrill]');
  if(!el) return;

  const kind = el.getAttribute('data-fovdrill');
  const key = el.getAttribute('data-key');
  if(!key) return;

  const row = fovRowByKey.get(key);
  if(!row) return;

  let title = '';
  let sub = 'Network filters applied (weeks/date/fleet/vehicle).';
  let rows = [];
  let dl = 'fov_evidence.csv';

  if(kind === 'vfBefore'){
    title = `FOV Evidence ‚Äî Verified Fatigue Before ‚Äî ${row.fleet} / ${row.vehicle}`;
    rows = row.vfBeforeEvents || [];
    dl = `${row.fleet}_${row.vehicle}_vf_before_first_fov.csv`.replace(/\s+/g,'_');
  }
  if(kind === 'lastVerified'){
    title = `FOV Evidence ‚Äî Last Verified Fatigue ‚Äî ${row.fleet} / ${row.vehicle}`;
    rows = row.lastVerifiedEvent || [];
    dl = `${row.fleet}_${row.vehicle}_last_verified_fatigue.csv`.replace(/\s+/g,'_');
  }
  if(kind === 'firstFov'){
    title = `FOV Evidence ‚Äî First FOV (Misaligned) ‚Äî ${row.fleet} / ${row.vehicle}`;
    rows = row.firstFovEvent || [];
    dl = `${row.fleet}_${row.vehicle}_first_fov_misaligned.csv`.replace(/\s+/g,'_');
  }
  if(kind === 'latestFov'){
    title = `FOV Evidence ‚Äî Latest FOV (Misaligned) ‚Äî ${row.fleet} / ${row.vehicle}`;
    rows = row.latestFovEvent || [];
    dl = `${row.fleet}_${row.vehicle}_latest_fov_misaligned.csv`.replace(/\s+/g,'_');
  }

  openEvidenceModal(title, sub, rows, dl);
});

/* =======================================================================================
   SECTION: Sorting handlers (Fleet / Interventions / FOV)
======================================================================================= */
function clearSortClasses(selector){
  document.querySelectorAll(selector).forEach(th => {
    th.classList.remove('sort-asc','sort-desc');
    th.classList.add('sortable');
  });
}
function setSortClass(th, dir){
  th.classList.remove('sort-asc','sort-desc');
  th.classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');
}

document.querySelector('#fleetTab thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-col]');
  if(!th) return;
  const col = th.getAttribute('data-col');
  if(!col) return;

  if(sortState.col === col){
    sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
  } else {
    sortState.col = col;
    sortState.dir = 'desc';
    if(col === 'fleet' || col === 'version_mix') sortState.dir = 'asc';
  }

  clearSortClasses('#fleetTab thead th[data-col]');
  setSortClass(th, sortState.dir);

  renderAll();
  schedulePersist();
});

document.querySelector('#interventionsTab thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-icol]');
  if(!th) return;
  const col = th.getAttribute('data-icol');
  if(!col) return;

  if(intSort.col === col){
    intSort.dir = (intSort.dir === 'asc') ? 'desc' : 'asc';
  } else {
    intSort.col = col;
    intSort.dir = 'desc';
    if(['dateISO','shift','fleet','vehicle','software_version','cap_time','last_email_time'].includes(col)) intSort.dir = 'asc';
  }

  clearSortClasses('#interventionsTab thead th[data-icol]');
  setSortClass(th, intSort.dir);

  renderAll();
  schedulePersist();
});

document.querySelector('#fovTab thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-fcol]');
  if(!th) return;
  const col = th.getAttribute('data-fcol');
  if(!col) return;

  if(fovSort.col === col){
    fovSort.dir = (fovSort.dir === 'asc') ? 'desc' : 'asc';
  } else {
    fovSort.col = col;
    fovSort.dir = 'desc';
    if(['vehicle_id','fleet','vehicle','gap_bucket','exposure_bucket','last_verified_ms','first_fov_ms','latest_fov_ms'].includes(col)) fovSort.dir = 'asc';
  }

  clearSortClasses('#fovTab thead th[data-fcol]');
  setSortClass(th, fovSort.dir);

  renderAll();
  schedulePersist();
});

// Trends tab - Best Performers table
document.querySelector('#trends-best-thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-tbest]');
  if(!th) return;
  const col = th.getAttribute('data-tbest');
  if(!col) return;

  if(trendsBestSort.col === col){
    trendsBestSort.dir = (trendsBestSort.dir === 'asc') ? 'desc' : 'asc';
  } else {
    trendsBestSort.col = col;
    trendsBestSort.dir = (col === 'fleet') ? 'asc' : 'desc';
  }

  clearSortClasses('#trends-best-thead th[data-tbest]');
  setSortClass(th, trendsBestSort.dir);

  renderAll();
  schedulePersist();
});

// Trends tab - Performance Leaders table
document.querySelector('#trends-leaders-thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-tleaders]');
  if(!th) return;
  const col = th.getAttribute('data-tleaders');
  if(!col) return;

  if(trendsLeadersSort.col === col){
    trendsLeadersSort.dir = (trendsLeadersSort.dir === 'asc') ? 'desc' : 'asc';
  } else {
    trendsLeadersSort.col = col;
    trendsLeadersSort.dir = (col === 'fleet') ? 'asc' : 'desc';
  }

  clearSortClasses('#trends-leaders-thead th[data-tleaders]');
  setSortClass(th, trendsLeadersSort.dir);

  renderAll();
  schedulePersist();
});

// Trends tab - Declining Fleets table
document.querySelector('#trends-worst-thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-tworst]');
  if(!th) return;
  const col = th.getAttribute('data-tworst');
  if(!col) return;

  if(trendsWorstSort.col === col){
    trendsWorstSort.dir = (trendsWorstSort.dir === 'asc') ? 'desc' : 'asc';
  } else {
    trendsWorstSort.col = col;
    trendsWorstSort.dir = (col === 'fleet') ? 'asc' : (col === 'delta') ? 'asc' : 'desc';
  }

  clearSortClasses('#trends-worst-thead th[data-tworst]');
  setSortClass(th, trendsWorstSort.dir);

  renderAll();
  schedulePersist();
});

// Trends tab - Weekly Precision table
document.querySelector('#trends-weekly-thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-tweekly]');
  if(!th) return;
  const col = th.getAttribute('data-tweekly');
  if(!col) return;

  if(trendsWeeklySort.col === col){
    trendsWeeklySort.dir = (trendsWeeklySort.dir === 'asc') ? 'desc' : 'asc';
  } else {
    trendsWeeklySort.col = col;
    trendsWeeklySort.dir = (col === 'week') ? 'asc' : 'desc';
  }

  clearSortClasses('#trends-weekly-thead th[data-tweekly]');
  setSortClass(th, trendsWeeklySort.dir);

  renderAll();
  schedulePersist();
});

// Trends tab - Volume Changes table
document.querySelector('#trends-volume-thead').addEventListener('click', (e) => {
  const th = e.target.closest('th[data-tvol]');
  if(!th) return;
  const col = th.getAttribute('data-tvol');
  if(!col) return;

  if(trendsVolumeSort.col === col){
    trendsVolumeSort.dir = (trendsVolumeSort.dir === 'asc') ? 'desc' : 'asc';
  } else {
    trendsVolumeSort.col = col;
    trendsVolumeSort.dir = (col === 'fleet') ? 'asc' : 'desc';
  }

  clearSortClasses('#trends-volume-thead th[data-tvol]');
  setSortClass(th, trendsVolumeSort.dir);

  renderAll();
  schedulePersist();
});

/* =======================================================================================
   SECTION: Trends Tab ‚Äî Sorting Functions
======================================================================================= */
function sortTrendsBest(rows){
  if(!trendsBestSort.col) return rows;
  const out = [...rows];
  const col = trendsBestSort.col;
  const dir = trendsBestSort.dir;
  
  out.sort((a, b) => {
    if(col === 'fleet'){
      return dir === 'asc' 
        ? a.fleet.localeCompare(b.fleet)
        : b.fleet.localeCompare(a.fleet);
    }
    if(col === 'rank'){
      return dir === 'asc' ? (a.rank - b.rank) : (b.rank - a.rank);
    }
    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return a.fleet.localeCompare(b.fleet);
    return dir === 'asc' ? (av - bv) : (bv - av);
  });
  return out;
}

function sortTrendsWorst(rows){
  if(!trendsWorstSort.col) return rows;
  const out = [...rows];
  const col = trendsWorstSort.col;
  const dir = trendsWorstSort.dir;
  
  out.sort((a, b) => {
    if(col === 'fleet'){
      return dir === 'asc' 
        ? a.fleet.localeCompare(b.fleet)
        : b.fleet.localeCompare(a.fleet);
    }
    if(col === 'rank'){
      return dir === 'asc' ? (a.rank - b.rank) : (b.rank - a.rank);
    }
    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return a.fleet.localeCompare(b.fleet);
    return dir === 'asc' ? (av - bv) : (bv - av);
  });
  return out;
}

function sortTrendsLeaders(rows){
  if(!trendsLeadersSort.col) return rows;
  const out = [...rows];
  const col = trendsLeadersSort.col;
  const dir = trendsLeadersSort.dir;
  
  out.sort((a, b) => {
    if(col === 'fleet'){
      return dir === 'asc' 
        ? a.fleet.localeCompare(b.fleet)
        : b.fleet.localeCompare(a.fleet);
    }
    if(col === 'rank'){
      return dir === 'asc' ? (a.rank - b.rank) : (b.rank - a.rank);
    }
    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return a.fleet.localeCompare(b.fleet);
    return dir === 'asc' ? (av - bv) : (bv - av);
  });
  return out;
}

function sortTrendsWeekly(rows){
  if(!trendsWeeklySort.col) return rows;
  const out = [...rows];
  const col = trendsWeeklySort.col;
  const dir = trendsWeeklySort.dir;
  
  out.sort((a, b) => {
    if(col === 'week'){
      return dir === 'asc' 
        ? a.week.localeCompare(b.week)
        : b.week.localeCompare(a.week);
    }
    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return a.week.localeCompare(b.week);
    return dir === 'asc' ? (av - bv) : (bv - av);
  });
  return out;
}

function sortTrendsVolume(rows){
  if(!trendsVolumeSort.col) return rows;
  const out = [...rows];
  const col = trendsVolumeSort.col;
  const dir = trendsVolumeSort.dir;
  
  out.sort((a, b) => {
    if(col === 'fleet'){
      return dir === 'asc' 
        ? a.fleet.localeCompare(b.fleet)
        : b.fleet.localeCompare(a.fleet);
    }
    const av = Number(a[col] ?? 0);
    const bv = Number(b[col] ?? 0);
    if(av === bv) return a.fleet.localeCompare(b.fleet);
    return dir === 'asc' ? (av - bv) : (bv - av);
  });
  return out;
}

/* =======================================================================================
   SECTION: Trends Tab ‚Äî Week-over-Week Precision Deltas
======================================================================================= */
function renderTrendsTab(eventsGlobal) {
  const nodata = document.getElementById('trends-nodata');
  const weeklySummary = document.getElementById('trends-summary');
  const weeklyTbody = document.getElementById('trends-weekly-tbody');
  const bestTbody = document.getElementById('trends-best-tbody');
  const worstTbody = document.getElementById('trends-worst-tbody');
  const leadersTbody = document.getElementById('trends-leaders-tbody');
  const volumeTbody = document.getElementById('trends-volume-tbody');
  const distributionChart = document.getElementById('trends-distribution-chart');
  const precisionChart = document.getElementById('trends-precision-chart');
  
  if (!eventsGlobal || eventsGlobal.length === 0) {
    weeklyTbody.innerHTML = '';
    bestTbody.innerHTML = '';
    worstTbody.innerHTML = '';
    leadersTbody.innerHTML = '';
    volumeTbody.innerHTML = '';
    weeklySummary.innerHTML = '';
    distributionChart.innerHTML = '<div style="padding:20px; text-align:center; color:#95a5a6;">No data</div>';
    precisionChart.innerHTML = '<div style="padding:20px; text-align:center; color:#95a5a6;">No data</div>';
    nodata.style.display = 'block';
    document.getElementById('trends-weekly-section').style.display = 'none';
    return;
  }

  // Get all selected weeks and sort them
  const weeks = Array.from(selectedWeeks).sort();
  
  if (weeks.length < 2) {
    weeklyTbody.innerHTML = '';
    bestTbody.innerHTML = '';
    worstTbody.innerHTML = '';
    volumeTbody.innerHTML = '';
    weeklySummary.innerHTML = '';
    distributionChart.innerHTML = '<div style="padding:20px; text-align:center; color:#95a5a6;">Upload at least 2 weeks</div>';
    precisionChart.innerHTML = '<div style="padding:20px; text-align:center; color:#95a5a6;">Upload at least 2 weeks</div>';
    nodata.style.display = 'block';
    document.getElementById('trends-weekly-section').style.display = 'none';
    return;
  }

  nodata.style.display = 'none';
  document.getElementById('trends-weekly-section').style.display = 'block';

  // Build a map: fleet -> week -> { total, valid, fov, fovMisaligned }
  const fleetWeekMap = new Map();
  const weekMetrics = new Map(); // Network-wide metrics per week
  
  for (const e of eventsGlobal) {
    const week = e.fileWeek;
    if (!selectedWeeks.has(week)) continue;
    
    const fleet = e.fleet;
    if (!fleet) continue;
    
    // Fleet-level metrics
    if (!fleetWeekMap.has(fleet)) {
      fleetWeekMap.set(fleet, new Map());
    }
    const weekMap = fleetWeekMap.get(fleet);
    if (!weekMap.has(week)) {
      weekMap.set(week, { total: 0, valid: 0, fov: 0, fovMisaligned: 0, otherEvents: 0 });
    }
    
    const metrics = weekMap.get(week);
    const { isFov, isValidFatigue } = classifyEvent(e);
    const isFovMis = isFovMisaligned(e);
    
    metrics.total++;
    if (isValidFatigue) metrics.valid++;
    if (isFov) metrics.fov++;
    if (isFovMis) metrics.fovMisaligned++;
    // otherEvents = total events excluding FOV and Valid alerts
    if (!isFov && !isValidFatigue) metrics.otherEvents++;

    // Network-wide metrics
    if (!weekMetrics.has(week)) {
      weekMetrics.set(week, { total: 0, valid: 0, fov: 0, fovMisaligned: 0 });
    }
    const wm = weekMetrics.get(week);
    wm.total++;
    if (isValidFatigue) wm.valid++;
    if (isFov) wm.fov++;
    if (isFovMis) wm.fovMisaligned++;
  }

  // Compare latest week vs previous selected week (not consecutive pairs)
  const latestWeek = weeks[weeks.length - 1];
  const previousWeek = weeks[weeks.length - 2];
  
  const deltas = [];
  const volumeChanges = [];
  const fleetCurrentPrecision = new Map(); // Latest precision per fleet
  
  for (const [fleet, weekMap] of fleetWeekMap.entries()) {
    // Get latest week precision for this fleet
    const latestMetrics = weekMap.get(latestWeek);
    if (latestMetrics) {
      const latestPrec = precisionExFov(latestMetrics.valid, latestMetrics.total, latestMetrics.fov);
      fleetCurrentPrecision.set(fleet, latestPrec);
    }

    // Compare latest vs previous week only
    const prevMetrics = weekMap.get(previousWeek);
    const currMetrics = weekMap.get(latestWeek);
    
    // Skip if either week is missing for this fleet
    if (!prevMetrics || !currMetrics) continue;
    
    const prevPrec = precisionExFov(prevMetrics.valid, prevMetrics.total, prevMetrics.fov);
    const currPrec = precisionExFov(currMetrics.valid, currMetrics.total, currMetrics.fov);
    const delta = currPrec - prevPrec;
    
    deltas.push({
      fleet,
      prevWeek: previousWeek,
      currWeek: latestWeek,
      prevPrec,
      currPrec,
      delta
    });

    // Volume changes - track each event type separately
    const prevOtherEvents = prevMetrics.otherEvents || 0;
    const currOtherEvents = currMetrics.otherEvents || 0;
    const prevFov = prevMetrics.fov;
    const currFov = currMetrics.fov;
    const prevValid = prevMetrics.valid;
    const currValid = currMetrics.valid;
    
    volumeChanges.push({
      fleet,
      prevWeek: previousWeek,
      currWeek: latestWeek,
      prevOtherEvents,
      currOtherEvents,
      prevFov,
      currFov,
      prevValid,
      currValid
    });
  }

  // Calculate fleet distribution by performance zone
  // Use toggle mode to determine if aggregating all weeks or just latest
  let redCount = 0, yellowCount = 0, greenCount = 0;
  const redFleets = [], yellowFleets = [], greenFleets = [];
  
  for (const [fleet, weekMap] of fleetWeekMap.entries()) {
    let fleetPrec;
    
    if (trendsAggregateMode === 'all') {
      // Aggregate metrics across all selected weeks for this fleet
      let totalValid = 0, totalEvents = 0, totalFov = 0;
      for (const week of weeks) {
        const metrics = weekMap.get(week);
        if (metrics) {
          totalValid += metrics.valid;
          totalEvents += metrics.total;
          totalFov += metrics.fov;
        }
      }
      fleetPrec = precisionExFov(totalValid, totalEvents, totalFov);
    } else {
      // Use latest week only
      const latestMetrics = weekMap.get(latestWeek);
      if (latestMetrics) {
        fleetPrec = precisionExFov(latestMetrics.valid, latestMetrics.total, latestMetrics.fov);
      } else {
        fleetPrec = 0;
      }
    }
    
    // Classify into zones
    if (fleetPrec < 50) {
      redCount++;
      redFleets.push(fleet);
    } else if (fleetPrec < 60) {
      yellowCount++;
      yellowFleets.push(fleet);
    } else {
      greenCount++;
      greenFleets.push(fleet);
    }
  }

  // Calculate network-wide precision and FOV based on toggle mode
  let displayPrecision, displayFOV;
  let totalFovMisaligned = 0;
  
  if (trendsAggregateMode === 'all') {
    // Aggregate across all selected weeks
    let totalValid = 0, totalEvents = 0, totalFov = 0;
    for (const week of weeks) {
      const metrics = weekMetrics.get(week);
      if (metrics) {
        totalValid += metrics.valid;
        totalEvents += metrics.total;
        totalFov += metrics.fov;
        totalFovMisaligned += metrics.fovMisaligned;
      }
    }
    displayPrecision = precisionExFov(totalValid, totalEvents, totalFov);
    displayFOV = totalFovMisaligned; // Show only misaligned FOV
  } else {
    // Use latest week only
    const latestWeekMetrics = weekMetrics.get(latestWeek);
    displayPrecision = precisionExFov(latestWeekMetrics.valid, latestWeekMetrics.total, latestWeekMetrics.fov);
    displayFOV = latestWeekMetrics.fovMisaligned; // Show only misaligned FOV
  }
  
  // For comparison, still use latest vs previous week
  const latestWeekMetrics = weekMetrics.get(latestWeek);
  const previousWeekMetrics = weekMetrics.get(previousWeek);
  const networkCurrentPrecision = precisionExFov(latestWeekMetrics.valid, latestWeekMetrics.total, latestWeekMetrics.fov);
  const networkPreviousPrecision = precisionExFov(previousWeekMetrics.valid, previousWeekMetrics.total, previousWeekMetrics.fov);
  const networkPrecisionDelta = networkCurrentPrecision - networkPreviousPrecision;
  
  // Calculate FOV misaligned delta for comparison
  const latestFovMisaligned = latestWeekMetrics.fovMisaligned;
  const previousFovMisaligned = previousWeekMetrics.fovMisaligned;
  const fovDelta = latestFovMisaligned - previousFovMisaligned;

  // Render Summary Cards with trend indicators
  const totalWeeks = weeks.length;
  const totalFleets = fleetWeekMap.size;
  
  const trendIcon = networkPrecisionDelta > 0 ? 'üìà' : networkPrecisionDelta < 0 ? 'üìâ' : '‚û°Ô∏è';
  const trendColor = networkPrecisionDelta >= 0 ? '#1e5631' : '#7b241c';
  
  // Determine KPI color based on precision range
  let kpiBackground, kpiBorder;
  if (displayPrecision < 50) {
    kpiBackground = '#fee';
    kpiBorder = '#e74c3c';
  } else if (displayPrecision < 60) {
    kpiBackground = '#fff9e6';
    kpiBorder = '#f39c12';
  } else {
    kpiBackground = '#e8f5e9';
    kpiBorder = '#4caf50';
  }
  
  // Dynamic labels based on toggle mode
  let precisionLabel, fovLabel;
  if (trendsAggregateMode === 'all') {
    precisionLabel = totalWeeks === 2 ? 'Network Precision (Latest Week)' : `Network Precision (${totalWeeks} Weeks)`;
    fovLabel = totalWeeks === 2 ? 'FOV Misaligned (Latest Week)' : `FOV Misaligned (${totalWeeks} Weeks)`;
  } else {
    precisionLabel = 'Network Precision (Latest Week)';
    fovLabel = 'FOV Misaligned (Latest Week)';
  }
  const comparisonLabel = totalWeeks === 2 ? 'WoW' : `${latestWeek} vs ${previousWeek}`;
  
  weeklySummary.innerHTML = `
    <div class="kpi" style="background:${kpiBackground}; border:2px solid ${kpiBorder};">
      <div class="k">${precisionLabel}</div>
      <div class="v" style="font-size:32px; color:#2c3e50;">${displayPrecision.toFixed(1)}%</div>
      <div style="font-size:11px; color:${trendColor}; margin-top:4px;">${trendIcon} ${networkPrecisionDelta >= 0 ? '+' : ''}${networkPrecisionDelta.toFixed(1)}% ${comparisonLabel}</div>
    </div>
    <div class="kpi">
      <div class="k">${fovLabel}</div>
      <div class="v">${displayFOV.toLocaleString()}</div>
      <div style="font-size:11px; color:#666; margin-top:4px;">${fovDelta >= 0 ? '+' : ''}${fovDelta.toLocaleString()} ${comparisonLabel}</div>
    </div>
    <div class="kpi">
      <div class="k">Active Fleets</div>
      <div class="v">${totalFleets}</div>
      <div style="font-size:11px; color:#666; margin-top:4px;">Across ${totalWeeks} ${totalWeeks === 1 ? 'week' : 'weeks'}</div>
    </div>
    <div class="kpi" style="cursor: help;" title="${redFleets.sort().join(', ')}">
      <div class="k">Red Zone Fleets</div>
      <div class="v" style="color:#e74c3c;">${redCount}</div>
      <div style="font-size:11px; color:#666; margin-top:4px;">&lt;50% precision</div>
    </div>
    <div class="kpi" style="cursor: help;" title="${yellowFleets.sort().join(', ')}">
      <div class="k">Yellow Zone</div>
      <div class="v" style="color:#f39c12;">${yellowCount}</div>
      <div style="font-size:11px; color:#666; margin-top:4px;">50-59.9%</div>
    </div>
    <div class="kpi" style="cursor: help;" title="${greenFleets.sort().join(', ')}">
      <div class="k">Green Zone</div>
      <div class="v" style="color:#27ae60;">${greenCount}</div>
      <div style="font-size:11px; color:#666; margin-top:4px;">‚â•60%</div>
    </div>
  `;

  // Render Fleet Distribution Chart (Simple Bar Chart)
  const totalDistribution = redCount + yellowCount + greenCount;
  const redPct = totalDistribution > 0 ? (redCount / totalDistribution * 100) : 0;
  const yellowPct = totalDistribution > 0 ? (yellowCount / totalDistribution * 100) : 0;
  const greenPct = totalDistribution > 0 ? (greenCount / totalDistribution * 100) : 0;

  distributionChart.innerHTML = `
    <div style="display:flex; height:60px; border-radius:8px; overflow:hidden; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
      ${redPct > 0 ? `<div style="flex:${redPct}; background:#e74c3c; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:18px;">${redCount}</div>` : ''}
      ${yellowPct > 0 ? `<div style="flex:${yellowPct}; background:#f39c12; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:18px;">${yellowCount}</div>` : ''}
      ${greenPct > 0 ? `<div style="flex:${greenPct}; background:#27ae60; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:18px;">${greenCount}</div>` : ''}
    </div>
    <div style="display:flex; justify-content:space-around; font-size:12px; color:#666;">
      <div><span style="display:inline-block; width:12px; height:12px; background:#e74c3c; border-radius:2px; margin-right:4px;"></span>Red: ${redPct.toFixed(0)}%</div>
      <div><span style="display:inline-block; width:12px; height:12px; background:#f39c12; border-radius:2px; margin-right:4px;"></span>Yellow: ${yellowPct.toFixed(0)}%</div>
      <div><span style="display:inline-block; width:12px; height:12px; background:#27ae60; border-radius:2px; margin-right:4px;"></span>Green: ${greenPct.toFixed(0)}%</div>
    </div>
  `;

  // Render Precision Trend Chart (Line Chart using SVG)
  const weeklyData = [];
  for (let i = 0; i < weeks.length; i++) {
    const week = weeks[i];
    const metrics = weekMetrics.get(week);
    const precision = precisionExFov(metrics.valid, metrics.total, metrics.fov);
    weeklyData.push({ week, precision });
  }

  const chartWidth = 600;
  const chartHeight = 100;
  const padding = 10;
  const usableWidth = chartWidth - (padding * 2);
  const usableHeight = chartHeight - (padding * 2);
  
  // Use fixed 0-100% scale to align with actual performance zones
  const minPrec = 0;
  const maxPrec = 100;
  const yRange = maxPrec - minPrec;

  let points = '';
  weeklyData.forEach((d, i) => {
    const x = padding + (i / (weeklyData.length - 1)) * usableWidth;
    const y = chartHeight - padding - ((d.precision - minPrec) / yRange) * usableHeight;
    points += `${x},${y} `;
  });

  const zoneColors = [
    { threshold: 60, color: '#27ae60', label: 'Green (‚â•60%)' },
    { threshold: 50, color: '#f39c12', label: 'Yellow (50-60%)' },
    { threshold: 0, color: '#e74c3c', label: 'Red (<50%)' }
  ];
  
  // Calculate actual zone heights based on thresholds
  const redZoneHeight = (50 / 100) * usableHeight;  // 0-50%
  const yellowZoneHeight = (10 / 100) * usableHeight;  // 50-60%
  const greenZoneHeight = (40 / 100) * usableHeight;  // 60-100%

  precisionChart.innerHTML = `
    <svg width="100%" height="150" viewBox="0 0 ${chartWidth} ${chartHeight + 50}" style="max-width:100%;">
      <!-- Background zones - aligned to actual precision thresholds -->
      <rect x="${padding}" y="${padding}" width="${usableWidth}" height="${greenZoneHeight}" fill="#d4edda" opacity="0.3"/>
      <rect x="${padding}" y="${padding + greenZoneHeight}" width="${usableWidth}" height="${yellowZoneHeight}" fill="#fff3cd" opacity="0.3"/>
      <rect x="${padding}" y="${padding + greenZoneHeight + yellowZoneHeight}" width="${usableWidth}" height="${redZoneHeight}" fill="#f8d7da" opacity="0.3"/>
      
      <!-- Trend line -->
      <polyline points="${points}" fill="none" stroke="#2c3e50" stroke-width="3" />
      
      <!-- Data points -->
      ${weeklyData.map((d, i) => {
        const x = padding + (i / (weeklyData.length - 1)) * usableWidth;
        const y = chartHeight - padding - ((d.precision - minPrec) / yRange) * usableHeight;
        const color = d.precision >= 60 ? '#27ae60' : d.precision >= 50 ? '#f39c12' : '#e74c3c';
        return `<circle cx="${x}" cy="${y}" r="4" fill="${color}" stroke="white" stroke-width="2"/>`;
      }).join('')}
      
      <!-- Percentage and Week Labels -->
      ${weeklyData.map((d, i) => {
        const x = padding + (i / (weeklyData.length - 1)) * usableWidth;
        const y = chartHeight - padding - ((d.precision - minPrec) / yRange) * usableHeight;
        // Always position labels below the point to avoid line overlap
        const labelY = y + 14;
        return `
          <text x="${x}" y="${labelY}" text-anchor="middle" font-size="9" fill="#2c3e50" font-weight="bold">
            ${d.precision.toFixed(1)}%
          </text>
          <text x="${x}" y="${labelY + 10}" text-anchor="middle" font-size="8" fill="#666">
            ${d.week}
          </text>
        `;
      }).join('')}
      
      <!-- Labels -->
      <text x="${chartWidth/2}" y="${chartHeight + 45}" text-anchor="middle" font-size="11" fill="#666">Weeks: ${weeks[0]} ‚Üí ${weeks[weeks.length-1]}</text>
    </svg>
    <div style="font-size:11px; color:#666; text-align:center; margin-top:5px;">
      Range: ${Math.min(...weeklyData.map(d => d.precision)).toFixed(1)}% - ${Math.max(...weeklyData.map(d => d.precision)).toFixed(1)}%
    </div>
  `;

  // Render Weekly Overview with enhanced visuals (excluding FOV from totals)
  let weeklyRowsData = weeklyData.map((d, idx) => {
    let delta = null;
    if (idx > 0) {
      delta = d.precision - weeklyData[idx - 1].precision;
    }
    
    const metrics = weekMetrics.get(d.week);
    return {
      week: d.week,
      total: metrics.total - metrics.fov, // Exclude FOV from total
      valid: metrics.valid,
      precision: d.precision,
      delta: delta,
      isLatest: idx === weeklyData.length - 1
    };
  });
  
  // Apply sorting
  weeklyRowsData = sortTrendsWeekly(weeklyRowsData);
  
  weeklyTbody.innerHTML = weeklyRowsData.map(d => {
    const deltaDisplay = d.delta === null ? '‚Äî' : 
      `<span class="chip ${d.delta < 0 ? 'chip-red' : d.delta > 0 ? 'chip-green' : 'chip-na'}">${d.delta >= 0 ? '+' : ''}${d.delta.toFixed(1)}%</span>`;
    
    return `
      <tr style="${d.isLatest ? 'background:#f8f9fa; font-weight:bold;' : ''}">
        <td><strong>${esc(d.week)}</strong> ${d.isLatest ? '(Latest)' : ''}</td>
        <td class="num">${d.total.toLocaleString()}</td>
        <td class="num">${d.valid.toLocaleString()}</td>
        <td class="num"><strong style="font-size:16px;">${d.precision.toFixed(1)}%</strong></td>
        <td class="num">${deltaDisplay}</td>
      </tr>
    `;
  }).join('');

  // Sort and render Performance Leaders (fleets with 60% or greater current precision)
  let leaders = deltas
    .filter(d => d.currPrec >= 60)
    .sort((a, b) => b.currPrec - a.currPrec)
    .map((d, idx) => ({ ...d, rank: idx + 1 }));
  
  // Apply sorting
  leaders = sortTrendsLeaders(leaders);
  
  leadersTbody.innerHTML = leaders.map((d, idx) => {
    const deltaClass = d.delta > 0 ? 'chip-green' : (d.delta < 0 ? 'chip-red' : 'chip-na');
    const deltaSign = d.delta > 0 ? '+' : '';
    const trophy = d.rank === 1 ? 'ü•á' : d.rank === 2 ? 'ü•à' : d.rank === 3 ? 'ü•â' : '';
    
    return `
      <tr style="${d.rank <= 3 ? 'background:#fff9e6;' : ''}">
        <td style="font-size:20px; text-align:center;">${trophy || d.rank}</td>
        <td><strong>${esc(d.fleet)}</strong></td>
        <td class="num">${d.prevPrec.toFixed(1)}%</td>
        <td class="num"><strong style="color:#f39c12; font-size:16px;">${d.currPrec.toFixed(1)}%</strong></td>
        <td class="num"><span class="chip ${deltaClass}" style="font-size:14px;">${deltaSign}${d.delta.toFixed(1)}%</span></td>
      </tr>
    `;
  }).join('');

  // Sort and render Top 5 Best Performers with enhanced visuals
  let best10 = deltas
    .sort((a, b) => b.delta - a.delta)
    .slice(0, 5)
    .map((d, idx) => ({ ...d, rank: idx + 1 }));
  
  // Apply sorting
  best10 = sortTrendsBest(best10);
  
  bestTbody.innerHTML = best10.map((d, idx) => {
    const deltaClass = d.delta > 0 ? 'chip-green' : (d.delta < 0 ? 'chip-red' : 'chip-na');
    const deltaSign = d.delta > 0 ? '+' : '';
    const trophy = d.rank === 1 ? 'ü•á' : d.rank === 2 ? 'ü•à' : d.rank === 3 ? 'ü•â' : '';
    
    return `
      <tr style="${d.rank <= 3 ? 'background:#f0fff4;' : ''}">
        <td style="font-size:20px; text-align:center;">${trophy || d.rank}</td>
        <td><strong>${esc(d.fleet)}</strong></td>
        <td class="num">${d.prevPrec.toFixed(1)}%</td>
        <td class="num"><strong style="color:#27ae60; font-size:16px;">${d.currPrec.toFixed(1)}%</strong></td>
        <td class="num"><span class="chip ${deltaClass}" style="font-size:14px;">${deltaSign}${d.delta.toFixed(1)}%</span></td>
      </tr>
    `;
  }).join('');

  // Sort and render Top 5 Worst Performers with enhanced visuals
  let worst10 = deltas
    .sort((a, b) => a.delta - b.delta)
    .slice(0, 5)
    .map((d, idx) => ({ ...d, rank: idx + 1 }));
  
  // Apply sorting
  worst10 = sortTrendsWorst(worst10);
  
  worstTbody.innerHTML = worst10.map((d, idx) => {
    const deltaClass = d.delta < 0 ? 'chip-red' : (d.delta > 0 ? 'chip-green' : 'chip-na');
    const deltaSign = d.delta > 0 ? '+' : '';
    
    return `
      <tr style="${d.rank <= 3 ? 'background:#fff5f5;' : ''}">
        <td><strong>${d.rank}</strong></td>
        <td><strong>${esc(d.fleet)}</strong></td>
        <td class="num">${d.prevPrec.toFixed(1)}%</td>
        <td class="num"><strong style="color:#e74c3c; font-size:16px;">${d.currPrec.toFixed(1)}%</strong></td>
        <td class="num"><span class="chip ${deltaClass}" style="font-size:14px;">${deltaSign}${d.delta.toFixed(1)}%</span></td>
      </tr>
    `;
  }).join('');

  // Sort and render Top 5 Volume Changes with enhanced visuals
  // Get checkbox states for activity filters
  const includeTotal = document.getElementById('trends-vol-total')?.checked ?? true;
  const includeFov = document.getElementById('trends-vol-fov')?.checked ?? true;
  const includeValid = document.getElementById('trends-vol-valid')?.checked ?? true;
  
  // Calculate deltas based on selected filters
  const volumeChangesWithDeltas = volumeChanges.map(d => {
    let prevTotal = 0;
    let currTotal = 0;
    
    if (includeTotal) {
      prevTotal += d.prevOtherEvents;
      currTotal += d.currOtherEvents;
    }
    if (includeFov) {
      prevTotal += d.prevFov;
      currTotal += d.currFov;
    }
    if (includeValid) {
      prevTotal += d.prevValid;
      currTotal += d.currValid;
    }
    
    const volDelta = currTotal - prevTotal;
    const volPct = prevTotal > 0 ? (volDelta / prevTotal * 100) : 0;
    
    return {
      ...d,
      prevTotal,
      currTotal,
      change: volDelta,
      changePercent: volPct
    };
  });
  
  let top10Volume = [...volumeChangesWithDeltas]
    .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))
    .slice(0, 5);
  
  // Apply sorting
  top10Volume = sortTrendsVolume(top10Volume);
  
  volumeTbody.innerHTML = top10Volume.map(d => {
    const deltaClass = d.change > 0 ? 'chip-red' : (d.change < 0 ? 'chip-green' : 'chip-na');
    const deltaSign = d.change > 0 ? '+' : '';
    const pctSign = d.changePercent > 0 ? '+' : '';
    
    return `
      <tr>
        <td>${esc(d.fleet)}</td>
        <td class="num">${d.prevTotal.toLocaleString()}</td>
        <td class="num"><strong>${d.currTotal.toLocaleString()}</strong></td>
        <td class="num"><span class="chip ${deltaClass}">${deltaSign}${d.change.toLocaleString()}</span></td>
        <td class="num"><span class="chip ${deltaClass}"><strong>${pctSign}${d.changePercent.toFixed(1)}%</strong></span></td>
      </tr>
    `;
  }).join('');
}

/* =======================================================================================
   SECTION: Render pipeline (Network filters -> Fleet-only class -> tab renders)
======================================================================================= */
function updateSortIndicators() {
  // Update Fleet tab
  if(sortState.col) {
    const th = document.querySelector(`#fleetTab thead th[data-col="${sortState.col}"]`);
    if(th) {
      clearSortClasses('#fleetTab thead th[data-col]');
      setSortClass(th, sortState.dir);
    }
  }
  
  // Update Interventions tab
  if(intSort.col) {
    const th = document.querySelector(`#interventionsTab thead th[data-icol="${intSort.col}"]`);
    if(th) {
      clearSortClasses('#interventionsTab thead th[data-icol]');
      setSortClass(th, intSort.dir);
    }
  }
  
  // Update FOV tab
  if(fovSort.col) {
    const th = document.querySelector(`#fovTab thead th[data-fcol="${fovSort.col}"]`);
    if(th) {
      clearSortClasses('#fovTab thead th[data-fcol]');
      setSortClass(th, fovSort.dir);
    }
  }
  
  // Update Trends Best Performers table
  if(trendsBestSort.col) {
    const th = document.querySelector(`#trends-best-thead th[data-tbest="${trendsBestSort.col}"]`);
    if(th) {
      clearSortClasses('#trends-best-thead th[data-tbest]');
      setSortClass(th, trendsBestSort.dir);
    }
  }
  
  // Update Trends Performance Leaders table
  if(trendsLeadersSort.col) {
    const th = document.querySelector(`#trends-leaders-thead th[data-tleaders="${trendsLeadersSort.col}"]`);
    if(th) {
      clearSortClasses('#trends-leaders-thead th[data-tleaders]');
      setSortClass(th, trendsLeadersSort.dir);
    }
  }
  
  // Update Trends Declining Fleets table
  if(trendsWorstSort.col) {
    const th = document.querySelector(`#trends-worst-thead th[data-tworst="${trendsWorstSort.col}"]`);
    if(th) {
      clearSortClasses('#trends-worst-thead th[data-tworst]');
      setSortClass(th, trendsWorstSort.dir);
    }
  }
  
  // Update Trends Weekly table
  if(trendsWeeklySort.col) {
    const th = document.querySelector(`#trends-weekly-thead th[data-tweekly="${trendsWeeklySort.col}"]`);
    if(th) {
      clearSortClasses('#trends-weekly-thead th[data-tweekly]');
      setSortClass(th, trendsWeeklySort.dir);
    }
  }
  
  // Update Trends Volume table
  if(trendsVolumeSort.col) {
    const th = document.querySelector(`#trends-volume-thead th[data-tvol="${trendsVolumeSort.col}"]`);
    if(th) {
      clearSortClasses('#trends-volume-thead th[data-tvol]');
      setSortClass(th, trendsVolumeSort.dir);
    }
  }
}

function renderAll(){
  updateDateDisplay();

  // Network filters (NO classification) ‚Äî source of truth for KPIs + Interventions + FOV
  currentNetworkFilteredEvents = filterEventsNetworkOnly();

  // Fleet table/drilldowns are a VIEW layer on top (Network + Classification)
  currentFilteredEvents = applyClassificationFilter_FleetTabOnly(currentNetworkFilteredEvents);

  // Build aggregations
  const netAgg = aggregateFleetVehicle(currentNetworkFilteredEvents);
  const viewAgg = aggregateFleetVehicle(currentFilteredEvents);

  // Option B: Stats row is NETWORK-only, with Total Events KPI toggle (Include FOV)
  renderTopStatsFromNetworkEvents(currentNetworkFilteredEvents, netAgg.fleets, netAgg.vehicles);

  // Fleet table uses classification-filtered view
  renderFleetTable(viewAgg.fleets, viewAgg.vehicles);

  // Interventions + FOV always use Network-only
  renderInterventionsTab(currentNetworkFilteredEvents);
  renderFovTab(currentNetworkFilteredEvents);
  
  // Trends tab uses Network-only events and applies classification filter like Fleet tab
  renderTrendsTab(currentFilteredEvents);
  
  // Update sort indicators after rendering
  updateSortIndicators();
}

/* =======================================================================================
   SECTION: Wire up controls
======================================================================================= */
function debounce(fn, ms=180){
  let t=null;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(()=>fn(...args), ms);
  };
}
const rerenderDebounced = debounce(() => { renderAll(); schedulePersist(); }, 120);

['vehicle','ds','de','fov-gap-filter','int-cap-text'].forEach(id => {
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', () => {
    // If date inputs change, keep date display synced
    if(id === 'ds' || id === 'de') updateDateDisplay();
    rerenderDebounced();
  });
  el.addEventListener('change', () => {
    if(id === 'ds' || id === 'de') updateDateDisplay();
    // Update vehicle dropdown when changing dates
    if(id === 'ds' || id === 'de') refreshVehicleDropdown();
    rerenderDebounced();
  });
});

// Report week dropdown listener removed - now using week checkboxes

// Fleet multi-select listener
document.getElementById('fleet').addEventListener('change', () => {
  // When fleet selection changes, update vehicle dropdown
  refreshVehicleDropdown();
  rerenderDebounced();
});

// Option B: Total Events KPI toggle (Include FOV)
document.getElementById('kpi-include-fov').addEventListener('change', () => {
  // No need to rebuild aggregates; just re-render so KPI updates consistently
  renderAll();
  schedulePersist();
});

// Trends aggregate mode toggle
document.getElementById('trends-aggregate-toggle').addEventListener('change', (e) => {
  trendsAggregateMode = e.target.checked ? 'all' : 'latest';
  renderAll();
  schedulePersist();
});

// Class search
document.getElementById('class-search').addEventListener('input', () => {
  refreshClassificationPanel();
  schedulePersist();
});

// Weeks all/none (buttons removed from UI - now handled by report-week dropdown)
const weeksAllBtn = document.getElementById('weeks-all');
if (weeksAllBtn) {
  weeksAllBtn.addEventListener('click', () => {
    weeksManuallyChanged = true;
    const all = Array.from(new Set(rawEvents.map(e => e.fileWeek))).sort();
    selectedWeeks = new Set(all);
    refreshWeeksPanel();
    refreshClassificationPanel();
    applyAutoDateRange();
    renderAll();
    schedulePersist();
  });
}

const weeksNoneBtn = document.getElementById('weeks-none');
if (weeksNoneBtn) {
  weeksNoneBtn.addEventListener('click', () => {
    weeksManuallyChanged = true;
    selectedWeeks = new Set();
    refreshWeeksPanel();
    refreshClassificationPanel();
    renderAll();
    schedulePersist();
  });
}

// Class all/none
document.getElementById('class-all').addEventListener('click', () => {
  classesManuallyChanged = true;
  const classes = getAvailableClassifications();
  selectedClasses = new Set(classes);
  refreshClassificationPanel();
  renderAll();
  schedulePersist();
});
document.getElementById('class-none').addEventListener('click', () => {
  classesManuallyChanged = true;
  selectedClasses = new Set();
  refreshClassificationPanel();
  renderAll();
  schedulePersist();
});

// Emails all/none (Interventions)
document.getElementById('emails-all').addEventListener('click', () => {
  emailsManuallyChanged = true;
  selectedEmailBuckets = new Set(getAllEmailBuckets());
  refreshEmailsPanel();
  renderAll();
  schedulePersist();
});
document.getElementById('emails-none').addEventListener('click', () => {
  emailsManuallyChanged = true;
  selectedEmailBuckets = new Set();
  refreshEmailsPanel();
  renderAll();
  schedulePersist();
});

// Zone checkbox listeners
document.querySelectorAll('.zone-checkbox').forEach(cb => {
  cb.addEventListener('change', () => {
    // If 'all' is checked, uncheck others
    if(cb.dataset.zone === 'all' && cb.checked) {
      document.querySelectorAll('.zone-checkbox').forEach(otherCb => {
        if(otherCb.dataset.zone !== 'all') otherCb.checked = false;
      });
    } else if(cb.dataset.zone !== 'all' && cb.checked) {
      // If any specific zone is checked, uncheck 'all'
      const allCb = document.querySelector('.zone-checkbox[data-zone="all"]');
      if(allCb) allCb.checked = false;
    }
    // If no checkboxes are checked, check 'all'
    const anyChecked = Array.from(document.querySelectorAll('.zone-checkbox')).some(c => c.checked);
    if(!anyChecked) {
      const allCb = document.querySelector('.zone-checkbox[data-zone="all"]');
      if(allCb) allCb.checked = true;
    }
    renderAll();
    schedulePersist();
  });
});

// Interventions zone checkbox event listeners
document.querySelectorAll('.int-zone-checkbox').forEach(cb => {
  cb.addEventListener('change', () => {
    // If 'all' is checked, uncheck others
    if(cb.dataset.zone === 'all' && cb.checked) {
      document.querySelectorAll('.int-zone-checkbox').forEach(otherCb => {
        if(otherCb.dataset.zone !== 'all') otherCb.checked = false;
      });
    } else if(cb.dataset.zone !== 'all' && cb.checked) {
      // If any specific zone is checked, uncheck 'all'
      const allCb = document.querySelector('.int-zone-checkbox[data-zone="all"]');
      if(allCb) allCb.checked = false;
    }
    // If no checkboxes are checked, check 'all'
    const anyChecked = Array.from(document.querySelectorAll('.int-zone-checkbox')).some(c => c.checked);
    if(!anyChecked) {
      const allCb = document.querySelector('.int-zone-checkbox[data-zone="all"]');
      if(allCb) allCb.checked = true;
    }
    renderInterventionsTab(currentNetworkFilteredEvents);
  });
});

// Reset filters (keeps data)
document.getElementById('reset-filters').addEventListener('click', () => {
  // reportWeek dropdown removed - now using weeks checkboxes
  
  // Reset fleet input (now using input with datalist)
  document.getElementById('fleet').value = '';
  
  // Reset vehicle dropdown
  document.getElementById('vehicle').value = '';
  
  // Reset dates
  document.getElementById('ds').value = '';
  document.getElementById('de').value = '';

  // Reset zone checkboxes
  document.querySelectorAll('.zone-checkbox').forEach(cb => {
    cb.checked = (cb.dataset.zone === 'all');
  });
  // Reset interventions zone checkboxes
  document.querySelectorAll('.int-zone-checkbox').forEach(cb => {
    cb.checked = (cb.dataset.zone === 'all');
  });
  document.getElementById('fov-gap-filter').value = 'all';
  document.getElementById('int-cap-text').value = '10';
  document.getElementById('kpi-include-fov').checked = false;

  // weeks
  weeksManuallyChanged = false;
  selectedWeeks = new Set();

  // classes
  classesManuallyChanged = false;
  selectedClasses = new Set();
  document.getElementById('class-search').value = '';

  // emails
  emailsManuallyChanged = false;
  selectedEmailBuckets = new Set();

  // expansion + sorts
  expandedFleets = new Set();
  sortState = { col:null, dir:'asc' };
  fovSort = { col:'events_count', dir:'desc' };
  intSort = { col:'verified_total', dir:'desc' };

  refreshVehicleDropdown();
  refreshWeeksPanel();
  refreshClassificationPanel();
  refreshEmailsPanel();
  applyAutoDateRange();
  renderAll();
  schedulePersist();
});

// Clear data (wipes saved IndexedDB + localStorage UI state)
document.getElementById('clear-data').addEventListener('click', async () => {
  rawEvents = [];
  selectedWeeks = new Set();
  weeksManuallyChanged = false;

  selectedClasses = new Set();
  classesManuallyChanged = false;

  selectedEmailBuckets = new Set();
  emailsManuallyChanged = false;

  expandedFleets = new Set();

  try { await idbClear(); } catch(_){}
  try { localStorage.removeItem(LS_KEY); } catch(_){}

  // File status removed: document.getElementById('file-status').textContent = 'No files selected';
  document.getElementById('csv-upload').value = '';
  document.getElementById('ds').value = '';
  document.getElementById('de').value = '';
  updateDateDisplay();

  refreshFleetDropdown();
  refreshVehicleDropdown();
  refreshWeeksPanel();
  refreshClassificationPanel();
  refreshEmailsPanel();
  renderAll();
});

// Weeks select panel buttons already wired above; keep as-is

// CSV upload handler
document.getElementById('csv-upload').addEventListener('change', async (e) => {
  showError(null);

  const files = Array.from(e.target.files || []);
  if(!files.length) return;

  try{
    // read all files
    const loaded = [];
    for(const f of files){
      const wk = fileNameToWeekKey(f.name) || 'Unknown';
      const text = await f.text();
      const evs = loadEventsFromCSV(text, wk);
      loaded.push(...evs);
    }

    // merge + dedupe by event_id
    rawEvents = dedupeAll([...(rawEvents||[]), ...loaded]);

    // status
    const wkSet = new Set(rawEvents.map(x => x.fileWeek));
    // File status removed: document.getElementById('file-status').textContent = `${files.length} file(s) ‚Ä¢ ${wkSet.size} week(s) ‚Ä¢ ${rawEvents.length.toLocaleString()} events`;

    // refresh UI pieces
    refreshFleetDropdown();
    refreshVehicleDropdown();
    refreshWeeksPanel();
    refreshClassificationPanel();
    refreshEmailsPanel();
    applyAutoDateRange();

    // render + persist
    renderAll();
    await persistAll();
  }catch(err){
    showError(err?.message || String(err));
  }
});

// Trends tab: Activity filter checkboxes
['trends-vol-total', 'trends-vol-fov', 'trends-vol-valid'].forEach(id => {
  const checkbox = document.getElementById(id);
  if (checkbox) {
    checkbox.addEventListener('change', () => {
      renderTrendsTab(currentNetworkFilteredEvents);
    });
  }
});

// Init
(async function init(){
  // restore saved data + UI
  await restoreAll();

  // If data was restored, rebuild panels
  refreshFleetDropdown();
  refreshWeeksPanel();
  refreshClassificationPanel();
  refreshEmailsPanel();

  // If weeks were restored and dates are blank, auto-range
  if(rawEvents.length){
    if(!document.getElementById('ds').value || !document.getElementById('de').value){
      applyAutoDateRange();
    }
  }

  // first render
  renderAll();
  
  // Add event listeners for collapsible sections to persist state
  document.querySelectorAll('.controls details').forEach(details => {
    details.addEventListener('toggle', () => {
      schedulePersist();
    });
  });
})();
</script>

</body>
</html>
